
/*!
leaflet.travelnotes - version 1.6.0 
build 00369 - 2019-11-21T21:59:23+0100 
Copyright 2017 2019 wwwouaiebe 
Contact: http//www.ouaie.be/
Sources: https://github.com/wwwouaiebe/leaflet.TravelNotes 
License: GPL-3.0
*/


!function(){"use strict";let e=function(){let e=new Map;return{setTranslations:t=>(t=t,void t.forEach(t=>e.set(t.msgid,t.msgstr))),getText:(t,o)=>(function(t,o){let n=e.get(t);return o&&n&&Object.getOwnPropertyNames(o).forEach(e=>n=n.replace("{"+e+"}",o[e])),n||t})(t,o)};var t}();let t=function(){let e={contextMenu:{timeout:1500},errorMessages:{timeout:2e4},routing:{auto:!0},language:"fr",itineraryPointMarker:{color:"red",weight:2,radius:7,fill:!1},searchPointMarker:{color:"green",weight:4,radius:20,fill:!1},searchPointPolyline:{color:"green",weight:4,radius:20,fill:!1},previousSearchLimit:{color:"green",fill:!1,weight:1},nextSearchLimit:{color:"red",fill:!1,weight:1},wayPoint:{reverseGeocoding:!1},route:{color:"#ff0000",width:3,dashArray:0,dashChoices:[{text:"——————",iDashArray:null},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}]},note:{reverseGeocoding:!1,grip:{size:10,opacity:0},polyline:{color:"gray",weight:1},style:"TravelNotes-NotesStyle",svgIconWidth:200,svgAnleMaxDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},svgZoom:17,svgAngleDistance:10,svgHamletDistance:200,svgVillageDistance:400,svgCityDistance:1200,svgTownDistance:1500,svgTimeOut:15e3,cityPrefix:"<span class='TravelNotes-NoteHtml-Address-City'>",cityPostfix:"</span>"},itineraryPointZoom:17,routeEditor:{displayEditionInHTMLPage:!0},travelEditor:{clearAfterSave:!0,startMinimized:!0,timeout:1e3,startupRouteEdition:!0},haveBeforeUnloadWarning:!0,overpassApiUrl:"https://lz4.overpass-api.de/api/interpreter",nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"}};function t(t){!function e(t,o){if("object"==typeof t&&"object"==typeof o)try{let n;for(n in o)"object"==typeof o[n]?e(t[n],o[n]):o[n]=t[n]||o[n];for(n in t)"object"==typeof t[n]?("[object Array]"==Object.prototype.toString.call(t[n])?o[n]=o[n]||[]:o[n]=o[n]||{},e(t[n],o[n])):o[n]=t[n]}catch(e){console.log(e),console.log("Not possible to overload Config")}}(t,e),e=function e(t){var o;for(o in t)"object"==typeof t[o]&&(t[o]=e(t[o]));return Object.freeze(t)}(e)}return{get contextMenu(){return e.contextMenu},get errorMessages(){return e.errorMessages},get routing(){return e.routing},get language(){return e.language},get itineraryPointMarker(){return e.itineraryPointMarker},get searchPointMarker(){return e.searchPointMarker},get searchPointPolyline(){return e.searchPointPolyline},get previousSearchLimit(){return e.previousSearchLimit},get nextSearchLimit(){return e.nextSearchLimit},get wayPoint(){return e.wayPoint},get route(){return e.route},get note(){return e.note},get itineraryPointZoom(){return e.itineraryPointZoom},get routeEditor(){return e.routeEditor},get travelEditor(){return e.travelEditor},get haveBeforeUnloadWarning(){return e.haveBeforeUnloadWarning},get overpassApiUrl(){return e.overpassApiUrl},get nominatim(){return e.nominatim},overload:e=>t(e)}}();var o=0,n=function(){return++o},a=function(e){const t=e;return Object.seal({get name(){return t},get version(){return"1.6.0"},get object(){return{name:t,version:"1.6.0"}},validate:function(e){return function(e){if(!e.objType)throw"No objType for "+t;if(!e.objType.name)throw"No name for "+t;if(t!==e.objType.name)throw"Invalid name for "+t;if(!e.objType.version)throw"No version for "+t;if("1.6.0"!==e.objType.version&&("1.0.0"===e.objType.version&&("Route"===e.objType.name&&(e.dashArray=0,e.hidden=!1),e.objType.version="1.1.0"),"1.1.0"===e.objType.version&&(e.objType.version="1.2.0"),"1.2.0"===e.objType.version&&(e.objType.version="1.3.0"),"1.3.0"===e.objType.version&&(e.objType.version="1.4.0"),"1.4.0"===e.objType.version&&("Route"===e.objType.name&&(e.edited=0),"Travel"===e.objType.name&&(e.editedRoute={}),e.objType.version="1.5.0"),"1.5.0"===e.objType.version&&(e.objType.version="1.6.0"),"1.6.0"!==e.objType.version))throw"invalid version for "+t;if(!e.objId)throw"No objId for "+t;return e}(e)}})},r=function(){const e=a("WayPoint");var t="",o=0,r=0,i=n();return Object.seal({get name(){return t},set name(e){t=e},get UIName(){return""!==t?t:0!==o&&0!==r?o.toFixed(6)+(0<o?" N - ":" S - ")+r.toFixed(6)+(0<r?" E":" W"):""},get lat(){return o},set lat(e){o=e},get lng(){return r},set lng(e){r=e},get latLng(){return[o,r]},set latLng(e){o=e[0],r=e[1]},get objId(){return i},get objType(){return e},get object(){return{name:t,lat:parseFloat(o.toFixed(6)),lng:parseFloat(r.toFixed(6)),objId:i,objType:e.object}},set object(a){!function(a){a=e.validate(a),t=a.name||"",o=a.lat||0,r=a.lng||0,i=n()}(a)}})},i=function(){const e=a("Itinerary");var t="",o="",r=c("ItineraryPoint"),i=c("Maneuver"),l=n();return Object.seal({get itineraryPoints(){return r},get maneuvers(){return i},get provider(){return t},set provider(e){t=e},get transitMode(){return o},set transitMode(e){o=e},get objId(){return l},get objType(){return e},get object(){return{itineraryPoints:r.object,maneuvers:i.object,provider:t,transitMode:o,objId:l,objType:e.object}},set object(a){!function(a){a=e.validate(a),r.object=a.itineraryPoints||[],i.object=a.maneuvers||[],t=a.provider||"",o=a.transitMode||"",l=n();for(var s=new Map,d=0,u=r.iterator;!u.done;)s.set(a.itineraryPoints[d].objId,u.value.objId),d++;for(var c=i.iterator;!c.done;)c.value.itineraryPointObjId=s.get(c.value.itineraryPointObjId)}(a)}})},l=function(){const e=a("Route");var o="",l=c("WayPoint");l.add(r()),l.add(r());var s=c("Note"),d=i(),u=5,v="#ff0000",g=0;t&&(u=t.route.width,v=t.route.color,g=t.route.dashArray);var m=!1,p=0,T=0,f=0,N=0,h=!1,L=n();return Object.seal({get wayPoints(){return l},get itinerary(){return d},get notes(){return s},get name(){return o},set name(e){o=e},get width(){return u},set width(e){u=e},get color(){return v},set color(e){v=e},get dashArray(){return g},set dashArray(e){g=e},get chain(){return m},set chain(e){m=e},get chainedDistance(){return p},set chainedDistance(e){p=e},get distance(){return T},set distance(e){T=e},get duration(){return f},set duration(e){f=e},get edited(){return N},set edited(e){!function(e){if("number"!=typeof e||0>e||2<e)throw"Invalid value for Route.edited : "+e;N=e}(e)},get hidden(){return h},set hidden(e){h=e},get objId(){return L},get objType(){return e},get object(){return{name:o,wayPoints:l.object,notes:s.object,itinerary:d.object,width:u,color:v,dashArray:g,chain:m,distance:parseFloat(T.toFixed(2)),duration:f,edited:N,hidden:h,chainedDistance:parseFloat(p.toFixed(2)),objId:L,objType:e.object}},set object(t){!function(t){t=e.validate(t),o=t.name||"",l.object=t.wayPoints||[],s.object=t.notes||[],d.object=t.itinerary||i().object,u=t.width||5,v=t.color||"#000000",g=t.dashArray||0,m=t.chain||!1,T=t.distance,f=t.duration,N=t.edited||0,h=t.hidden||!1,p=t.chainedDistance,L=n()}(t)}})},s=function(){const e=a("Note");var t=n(),o=40,r=40,i="",l="",s="",d="",u="",c="",v=0,g=0,m=0,p=0,T=-1,f=0;return Object.seal({get isRouteNote(){return-1!==T},get iconHeight(){return o},set iconHeight(e){o=e},get iconWidth(){return r},set iconWidth(e){r=e},get iconContent(){return i},set iconContent(e){i=e},get popupContent(){return l},set popupContent(e){l=e},get tooltipContent(){return s},set tooltipContent(e){s=e},get phone(){return d},set phone(e){d=e},get url(){return u},set url(e){u=e},get address(){return c},set address(e){c=e},get iconLat(){return v},set iconLat(e){v=e},get iconLng(){return g},set iconLng(e){g=e},get iconLatLng(){return[v,g]},set iconLatLng(e){v=e[0],g=e[1]},get lat(){return m},set lat(e){m=e},get lng(){return p},set lng(e){p=e},get latLng(){return[m,p]},set latLng(e){m=e[0],p=e[1]},get distance(){return T},set distance(e){T=e},get chainedDistance(){return f},set chainedDistance(e){f=e},get objId(){return t},get objType(){return e},get object(){return{iconHeight:o,iconWidth:r,iconContent:i,popupContent:l,tooltipContent:s,phone:d,url:u,address:c,iconLat:parseFloat(v.toFixed(6)),iconLng:parseFloat(g.toFixed(6)),lat:parseFloat(m.toFixed(6)),lng:parseFloat(p.toFixed(6)),distance:parseFloat(T.toFixed(2)),chainedDistance:parseFloat(f.toFixed(2)),objId:t,objType:e.object}},set object(a){!function(a){a=e.validate(a),o=a.iconHeight||40,r=a.iconWidth||40,i=a.iconContent||"",l=a.popupContent||"",s=a.tooltipContent||"",d=a.phone||"",u=a.url||"",c=a.address||"",v=a.iconLat||0,g=a.iconLng||0,m=a.lat||0,p=a.lng||0,T=a.distance||-1,f=a.chainedDistance,t=n()}(a)}})},d=function(){const e=a("Maneuver");var t=n(),o="",r="",i=-1,l=0,s=0;return Object.seal({get iconName(){return o},set iconName(e){o=e},get instruction(){return r},set instruction(e){r=e},get itineraryPointObjId(){return i},set itineraryPointObjId(e){i=e},get distance(){return l},set distance(e){l=e},get duration(){return s},set duration(e){s=e},get objId(){return t},get objType(){return e},get object(){return{iconName:o,instruction:r,distance:parseFloat(l.toFixed(2)),duration:s,itineraryPointObjId:i,objId:t,objType:e.object}},set object(a){!function(a){a=e.validate(a),o=a.iconName||"",r=a.instruction||"",l=a.distance||0,s=a.duration||0,i=a.itineraryPointObjId||-1,t=n()}(a)}})},u=function(){const e=a("ItineraryPoint");var t=0,o=0,r=0,i=n();return Object.seal({get lat(){return t},set lat(e){t=e},get lng(){return o},set lng(e){o=e},get latLng(){return[t,o]},set latLng(e){t=e[0],o=e[1]},get distance(){return r},set distance(e){r=e},get objId(){return i},get objType(){return e},get object(){return{lat:parseFloat(t.toFixed(6)),lng:parseFloat(o.toFixed(6)),distance:parseFloat(r.toFixed(2)),objId:i,objType:e.object}},set object(a){!function(a){a=e.validate(a),t=a.lat||0,o=a.lng||0,r=a.distance||0,i=n()}(a)}})},c=function(e){var t=[],o=e,n=function(e){if(!e.objType||!e.objType.name||e.objType.name!==o)throw"invalid object name for add function";t.push(e)},a=function(e){return t.findIndex(function(t){return t.objId===e})},i=function(){var e=-1;return{get value(){return e<t.length?t[e]:null},get done(){return++e>=t.length},get first(){return 0===e},get last(){return e>=t.length-1},get index(){return e}}},c=function(e,o,n){var r=a(e);if(-1===r)throw"invalid objId for next or previous function";for(o||(o=function(){return!0}),r+=n;-1<r&&r<t.length&&!o(t[r]);)r+=n;return-1===r||t.length===r?null:t[r]};return Object.seal({add:function(e){n(e)},forEach:function(e){return function(e){for(var t=null,o=i();!o.done;)t=e(o.value,t);return t}(e)},getAt:function(e){return function(e){var o=a(e);return-1===o?null:t[o]}(e)},moveTo:function(e,o,n){!function(e,o,n){var r=a(e),i=a(o);n||i++,t.splice(i,0,t[r]),i<r&&r++,t.splice(r,1)}(e,o,n)},next:function(e,t){return c(e,t,1)},previous:function(e,t){return c(e,t,-1)},remove:function(e){!function(e){if(-1===a(e))throw"invalid objId for remove function";t.splice(a(e),1)}(e)},removeAll:function(e){e?t.splice(1,t.length-2):t.length=0},replace:function(e,o){!function(e,o){var n=a(e);if(-1===n)throw"invalid objId for replace function";t[n]=o}(e,o)},reverse:function(){t.reverse()},sort:function(e){!function(e){t.sort(e)}(e)},swap:function(e,o){!function(e,o){var n=a(e);if(-1===n||0===n&&o||t.length-1===n&&!o)throw"invalid objId for swap function";var r=t[n];t[n]=t[n+(o?-1:1)],t[n+(o?-1:1)]=r}(e,o)},get first(){return t[0]},get iterator(){return i()},get last(){return t[t.length-1]},get length(){return t.length},get object(){return function(){for(var e=[],t=i();!t.done;)e.push(t.value.object);return e}()},set object(e){!function(e){var a;t.length=0,e.forEach(function(e){switch(o){case"Route":a=l();break;case"Note":a=s();break;case"WayPoint":a=r();break;case"Maneuver":a=d();break;case"ItineraryPoint":a=u();break;default:throw"invalid ObjName ( "+o+" ) in Collection.m_SetObject"}a.object=e,n(a)})}(e)}})},v=function(){const e=a("Travel");var t=l(),o="TravelNotes",r=c("Route"),i=c("Note"),s=n(),d=!1,u={};return Object.seal({get editedRoute(){return t},set editedRoute(e){t=e},get routes(){return r},get notes(){return i},get name(){return o},set name(e){o=e},get readOnly(){return d},set readOnly(e){d=e},get userData(){return u},set userData(e){u=e},get objId(){return s},get objType(){return e},get object(){return{editedRoute:t.object,name:o,routes:r.object,notes:i.object,userData:u,readOnly:d,objId:s,objType:e.object}},set object(a){!function(a){a=e.validate(a),t.object=a.editedRoute||l(),o=a.name||"",u=a.userData||{},d=a.readOnly||!1,r.object=a.routes||[],i.object=a.notes||[],s=n()}(a)}})},g=function(){return{get UUID(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},storageAvailable:function(e){try{var t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(e){return!1}},fileAPIAvailable:function(){try{return new File(["testdata"],{type:"text/plain"}),!0}catch(e){return!!window.navigator.msSaveOrOpenBlob}},saveFile:function(e,t,o){if(o||(o="text/plain"),window.navigator.msSaveOrOpenBlob)try{window.navigator.msSaveOrOpenBlob(new Blob([t]),e)}catch(e){console.log(e)}else try{var n=window.URL.createObjectURL(new File([t],{type:o})),a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",e),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(n)}catch(e){console.log(e)}},formatTime:function(t){if(0===(t=Math.floor(t)))return"";var o=Math.floor(t/86400),n=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),r=Math.floor(t%60);return 0<o?o+"&nbsp;"+e.getText("Utilities - Day")+"&nbsp;"+n+"&nbsp;"+e.getText("Utilities - Hour"):0<n?n+"&nbsp;"+e.getText("Utilities - Hour")+"&nbsp;"+a+"&nbsp;"+e.getText("Utilities - Minute"):0<a?a+"&nbsp;"+e.getText("Utilities - Minute"):r+"&nbsp;"+e.getText("Utilities - Second")},formatDistance:function(e){return 0===(e=Math.floor(e))?"":Math.floor(e/1e3)+","+Math.floor(e%1e3/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+"&nbsp;km"},formatLat:function(e){return e>0?e.toFixed(6)+"&nbsp;N":(-e).toFixed(6)+"&nbsp;S"},formatLng:function(e){return e>0?e.toFixed(6)+"&nbsp;E":(-e).toFixed(6)+"&nbsp;W"},formatLatLng:function(e){return this.formatLat(e[0])+"&nbsp;-&nbsp;"+this.formatLng(e[1])}}};let m=function(){let e={map:null,providers:new Map,mapObjects:new Map,travel:v(),editedRouteObjId:-1,routing:Object.seal({provider:"",transitMode:""}),searchData:[],UUID:g().UUID};return Object.seal({get map(){return e.map},set map(t){e.map=t},get providers(){return e.providers},get mapObjects(){return e.mapObjects},get travel(){return e.travel},set travel(t){e.travel=t},get editedRouteObjId(){return e.editedRouteObjId},set editedRouteObjId(t){e.editedRouteObjId=t},get routeEdition(){return e.routeEdition},get routing(){return e.routing},get searchData(){return e.searchData},set searchData(t){e.searchData=t},get translations(){return e.translations},get UUID(){return e.UUID}})}();var p={};function T(e){return Math.floor(Math.abs(e)+.5)*(e>=0?1:-1)}function f(e,t,o){var n=(e=T(e*o))-(t=T(t*o));n<<=1,e-t<0&&(n=~n);for(var a="";n>=32;)a+=String.fromCharCode(63+(32|31&n)),n>>=5;return a+=String.fromCharCode(n+63)}function N(e){for(var t=[],o=0;o<e.length;o++)t.push(e[o].slice().reverse());return t}p.decode=function(e,t){for(var o,n=0,a=0,r=0,i=[],l=0,s=0,d=null,u=Math.pow(10,Number.isInteger(t)?t:5);n<e.length;){d=null,l=0,s=0;do{s|=(31&(d=e.charCodeAt(n++)-63))<<l,l+=5}while(d>=32);o=1&s?~(s>>1):s>>1,l=s=0;do{s|=(31&(d=e.charCodeAt(n++)-63))<<l,l+=5}while(d>=32);a+=o,r+=1&s?~(s>>1):s>>1,i.push([a/u,r/u])}return i},p.encode=function(e,t){if(!e.length)return"";for(var o=Math.pow(10,Number.isInteger(t)?t:5),n=f(e[0][0],0,o)+f(e[0][1],0,o),a=1;a<e.length;a++){var r=e[a],i=e[a-1];n+=f(r[0],i[0],o),n+=f(r[1],i[1],o)}return n},p.fromGeoJSON=function(e,t){if(e&&"Feature"===e.type&&(e=e.geometry),!e||"LineString"!==e.type)throw new Error("Input must be a GeoJSON LineString");return p.encode(N(e.coordinates),t)},p.toGeoJSON=function(e,t){return{type:"LineString",coordinates:N(p.decode(e,t))}},"object"==typeof module&&module.exports&&(module.exports=p);var h=function(){return Object.seal({create:function(e,t,o){var n;if(n="text"===e.toLowerCase()?document.createTextNode(""):document.createElement(e),o&&o.appendChild(n),t)for(var a in t)try{n[a]=t[a]}catch(e){console.log("Invalid property : "+a)}return n}})},y=null,b=function(){var o=function(){document.getElementById("TravelNotes-Control-ErrorDataDiv").classList.add("TravelNotes-Control-HiddenList"),document.getElementById("TravelNotes-Control-ErrorMessageDiv").innerHTML=""};return{createUI:function(t){!function(t){if(!document.getElementById("TravelNotes-Control-ErrorDataDiv")){var n=h(),a=n.create("div",{id:"TravelNotes-Control-ErrorDataDiv",className:"TravelNotes-Control-DataDiv TravelNotes-Control-HiddenList"},t),r=n.create("div",{id:"TravelNotes-Control-ErrorHeaderDiv",className:"TravelNotes-Control-HeaderDiv TravelNotes-Control-HiddenList"},a);n.create("span",{innerHTML:"&#x274c",title:e.getText("ErrorEditorUI - Hide"),id:"TravelNotes-Control-ErrorExpandButton",className:"TravelNotes-Control-HiddenList"},r).addEventListener("click",function(e){e.stopPropagation(),document.getElementById("TravelNotes-Control-ErrorMessageDiv").innerHTML.length&&o()},!1),n.create("div",{id:"TravelNotes-Control-ErrorMessageDiv"},a)}}(t)},set message(e){!function(e){y&&(clearTimeout(y),y=null),document.getElementById("TravelNotes-Control-ErrorMessageDiv").innerHTML=e,document.getElementById("TravelNotes-Control-ErrorDataDiv").classList.remove("TravelNotes-Control-HiddenList"),y=setTimeout(o,t.errorMessages.timeout)}(e)},get message(){return document.getElementById("TravelNotes-Control-ErrorDataDiv").innerHTML}}};let I=Object.seal({showError:e=>{b().message='<span class="TravelNotes-Control-Error">'+e+"</span>"},clear:()=>{b().message=""}});var C=function(){return Object.seal({getRoute:function(e){return function(e){var t=null;return(t=m.travel.routes.getAt(e))||e===m.travel.editedRoute.objId&&(t=m.travel.editedRoute),t||console.log("Invalid noteObjId "+e+" for function DataSearchEngine.getRoute ( )"),t}(e)},getNoteAndRoute:function(e){return function(e){var t=null;if(t=m.travel.notes.getAt(e))return{note:t,route:null};for(var o=m.travel.routes.iterator;!o.done;)if(t=o.value.notes.getAt(e))return{note:t,route:o.value};return(t=m.travel.editedRoute.notes.getAt(e))?{note:t,route:m.travel.editedRoute}:(console.log("Invalid noteObjId "+e+" for function DataSearchEngine.getNote ( )"),{note:null,route:null})}(e)},getWayPoint:function(e){return function(e){for(var t=null,o=m.travel.routes.iterator;!o.done;)if(t=o.value.wayPoints.getAt(e))return t;return(t=m.travel.editedRoute.wayPoints.getAt(e))||(console.log("Invalid wayPointObjId "+e+" for function DataSearchEngine.getWayPoint ( )"),null)}(e)}})},E=0,D=h(),x=function(e){e.stopPropagation();try{e.dataTransfer.setData("Text",e.target.dataObjId),e.dataTransfer.dropEffect="move"}catch(e){console.log(e)}E=e.target.dataObjId-1},A=function(e){e.preventDefault()},R=function(e){e.preventDefault();for(var t=e.target;!t.dataObjId;)t=t.parentElement;var o=t.getBoundingClientRect(),n=new Event("SortableListDrop");n.draggedObjId=E+1,n.targetObjId=t.dataObjId,n.draggedBefore=e.clientY-o.top<o.bottom-e.clientY,t.parentNode.dispatchEvent(n)},B=function(e){var t=new Event("SortableListDelete");t.itemNode=e.target.parentNode,e.target.parentNode.parentNode.dispatchEvent(t),e.stopPropagation()},j=function(e){var t=new Event("SortableListUpArrow");t.itemNode=e.target.parentNode,e.target.parentNode.parentNode.dispatchEvent(t),e.stopPropagation()},M=function(e){var t=new Event("SortableListDownArrow");t.itemNode=e.target.parentNode,e.target.parentNode.parentNode.dispatchEvent(t),e.stopPropagation()},P=function(e){var t=new Event("SortableListRightArrow");t.itemNode=e.target.parentNode,e.target.parentNode.parentNode.dispatchEvent(t),e.stopPropagation()},w=function(e){var t=new Event("SortableListChange");t.dataObjId=e.target.parentNode.dataObjId,t.changeValue=e.target.value,e.target.parentNode.parentNode.dispatchEvent(t),e.stopPropagation()},S=function(e){e.deltaY&&(e.target.scrollTop=e.target.scrollTop+10*e.deltaY),e.stopPropagation()},O=function(t,o){var n=function(t,o,n,i,s){t=t||"",o=o||"",n=n||"",i=i||-1;var d=D.create("div",{draggable:!1,className:"TravelNotes-SortableList-Item"});D.create("div",{className:"TravelNotes-SortableList-ItemTextIndex",innerHTML:o},d);var u=D.create("input",{type:"text",className:"TravelNotes-SortableList-ItemInput",placeholder:n,value:t},d);u.addEventListener("change",w,!1),u.addEventListener("focus",function(e){e.target.parentElement.draggable=!1},!1),u.addEventListener("blur",function(e){e.target.parentElement.draggable=e.target.parentElement.canDrag},!1),D.create("div",{className:"TravelNotes-SortableList-ItemUpArrowButton",title:e.getText("SortableList - Move up"),innerHTML:String.fromCharCode(8679)},d).addEventListener("click",j,!1),D.create("div",{className:"TravelNotes-SortableList-ItemDownArrowButton",title:e.getText("SortableList - Move down"),innerHTML:String.fromCharCode(8681)},d).addEventListener("click",M,!1);var c=D.create("div",{className:"TravelNotes-SortableList-ItemRightArrowButton",title:e.getText("SortableList - Edit"),innerHTML:String.fromCharCode(8688)},d);"AllSort"===r.listStyle&&c.addEventListener("click",P,!1),D.create("div",{className:"TravelNotes-SortableList-ItemDeleteButton",title:e.getText("SortableList - Delete"),innerHTML:"&#x267b;"},d).addEventListener("click",B,!1),d.dataObjId=i,d.canDrag=!1,("LimitedSort"!==r.listStyle||1<a.length)&&!s&&(d.draggable=!0,d.addEventListener("dragstart",x,!1),d.classList.add("TravelNotes-SortableList-MoveCursor"),d.canDrag=!0),a.push(d),l.appendChild(d)},a=[],r={minSize:2,listStyle:"AllSort",id:"TravelNotes-SortableList-Container"};for(var i in t)r[i]=t[i];"LimitedSort"===r.listStyle&&2>r.minSize&&(r.minSize=0);var l=D.create("div",{id:r.id,className:"TravelNotes-SortableList-Container"});l.classList.add(r.listStyle),l.addEventListener("drop",R,!1),l.addEventListener("dragover",A,!1),l.addEventListener("wheel",S,!1),o&&o.appendChild(l);for(var s=0;s<r.minSize;s++)n();return Object.seal({removeAllItems:function(){!function(){for(var e=0;e<a.length;e++)l.removeChild(a[e]);a.length=0}()},addItem:function(e,t,o,a,r){n(e,t,o,a,r)},get container(){return l}})},H=function(e,t){return O(e,t)},k=null,U=function(){var t=function(t){if(t.stopPropagation(),-1!==m.editedRouteObjId){document.getElementById("TravelNotes-Control-RouteHeaderDiv").classList.toggle("TravelNotes-Control-SmallHeader"),document.getElementById("TravelNotes-Control-RouteDataDiv").classList.toggle("TravelNotes-Control-HiddenList"),document.getElementById("TravelNotes-Control-RouteButtonsDiv").classList.toggle("TravelNotes-Control-HiddenList");var o=document.getElementById("TravelNotes-Control-RouteDataDiv").classList.contains("TravelNotes-Control-HiddenList");document.getElementById("TravelNotes-Control-RouteExpandButton").innerHTML=o?"&#x25b6;":"&#x25bc;",document.getElementById("TravelNotes-Control-RouteExpandButton").title=o?e.getText("RouteEditorUI - Show"):e.getText("RouteEditorUI - Hide")}},o=function(e){e.stopPropagation(),Ve.removeWayPoint(e.itemNode.dataObjId)},n=function(e){e.stopPropagation(),Ve.swapWayPoints(e.itemNode.dataObjId,!0)},a=function(e){e.stopPropagation(),Ve.swapWayPoints(e.itemNode.dataObjId,!1)},r=function(e){e.stopPropagation(),Ve.renameWayPoint(e.dataObjId,e.changeValue)},i=function(e){e.stopPropagation(),Ve.wayPointDropped(e.draggedObjId,e.targetObjId,e.draggedBefore)},l=function(t){t.stopPropagation(),document.getElementById("TravelNotes-Control-RouteDataDiv").classList.toggle("TravelNotes-Control-ExpandedList");var o=document.getElementById("TravelNotes-Control-RouteDataDiv").classList.contains("TravelNotes-Control-ExpandedList");document.getElementById("TravelNotes-Control-ExpandWayPointsListButton").innerHTML=o?"&#x25b3;":"&#x25bd;",document.getElementById("TravelNotes-Control-ExpandWayPointsListButton").title=o?e.getText("RouteEditorUI - Reduce the list"):e.getText("RouteEditorUI - Expand the list")},s=function(e){e.stopPropagation(),ze.cancelEdition()},d=function(e){e.stopPropagation(),ze.saveEdition()},u=function(e){e.stopPropagation(),ze.saveGpx()},c=function(e){e.stopPropagation(),Ve.reverseWayPoints()},v=function(e){e.stopPropagation(),Ve.removeAllWayPoints()};return Object.seal({createUI:function(g){!function(g){if(!document.getElementById("TravelNotes-Control-RouteDataDiv")){var m=h(),p=m.create("div",{id:"TravelNotes-Control-RouteHeaderDiv",className:"TravelNotes-Control-HeaderDiv"},g);m.create("span",{innerHTML:"&#x25bc;",id:"TravelNotes-Control-RouteExpandButton",className:"TravelNotes-Control-ExpandButton"},p).addEventListener("click",t,!1),m.create("span",{innerHTML:e.getText("RouteEditorUI - Waypoints"),id:"TravelNotes-Control-RouteHeaderText",className:"TravelNotes-Control-HeaderText"},p);var T=m.create("div",{id:"TravelNotes-Control-RouteDataDiv",className:"TravelNotes-Control-DataDiv"},g);(k=H({minSize:0,listStyle:"LimitedSort",id:"TravelNotes-Control-RouteWaypointsList"},T)).container.addEventListener("SortableListDelete",o,!1),k.container.addEventListener("SortableListUpArrow",n,!1),k.container.addEventListener("SortableListDownArrow",a,!1),k.container.addEventListener("SortableListChange",r,!1),k.container.addEventListener("SortableListDrop",i,!1);var f=m.create("div",{id:"TravelNotes-Control-RouteButtonsDiv",className:"TravelNotes-Control-ButtonsDiv"},g);m.create("div",{id:"TravelNotes-Control-ExpandWayPointsListButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Expand the list"),innerHTML:"&#x25bd;"},f).addEventListener("click",l,!1),m.create("div",{id:"TravelNotes-Control-CancelRouteButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Cancel"),innerHTML:"&#x274c"},f).addEventListener("click",s,!1),m.create("div",{id:"TravelNotes-Control-SaveRouteButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Save"),innerHTML:"&#x1f4be;"},f).addEventListener("click",d,!1),m.create("div",{id:"TravelNotes-Control-gpxButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Save the route in a gpx file"),innerHTML:"gpx"},f).addEventListener("click",u,!1),m.create("div",{id:"TravelNotes-Control-ReverseWayPointsButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Invert waypoints"),innerHTML:"&#x21C5;"},f).addEventListener("click",c,!1),m.create("div",{id:"TravelNotes-Control-RemoveAllWayPointsButton",className:"TravelNotes-Control-Button",title:e.getText("RouteEditorUI - Delete all waypoints"),innerHTML:"&#x267b;"},f).addEventListener("click",v,!1)}}(g)},expand:function(){document.getElementById("TravelNotes-Control-RouteExpandButton").innerHTML="&#x25bc;",document.getElementById("TravelNotes-Control-RouteExpandButton").title="Masquer",document.getElementById("TravelNotes-Control-RouteDataDiv").classList.remove("TravelNotes-Control-HiddenList"),document.getElementById("TravelNotes-Control-RouteButtonsDiv").classList.remove("TravelNotes-Control-HiddenList")},reduce:function(){document.getElementById("TravelNotes-Control-RouteExpandButton").innerHTML="&#x25b6;",document.getElementById("TravelNotes-Control-RouteExpandButton").title="Afficher",document.getElementById("TravelNotes-Control-RouteDataDiv").classList.add("TravelNotes-Control-HiddenList"),document.getElementById("TravelNotes-Control-RouteButtonsDiv").classList.add("TravelNotes-Control-HiddenList")},setWayPointsList:function(){!function(){if(k.removeAllItems(),-1!==m.editedRouteObjId)for(var t=m.travel.editedRoute.wayPoints.iterator;!t.done;){var o=t.first?"A":t.last?" B":t.index,n=t.first?e.getText("RouteEditorUI - Start"):t.last?e.getText("RouteEditorUI - End"):e.getText("RouteEditorUI - Via");k.addItem(t.value.UIName,o,n,t.value.objId,t.last)}}()}})},F=!1,W=function(){var e=function(e){F=!1,I().showError(e)},t=function(){F=!1,ze.computeRouteDistances(m.travel.editedRoute);for(var e=m.travel.editedRoute.wayPoints.iterator;!e.done;)e.first?e.value.latLng=m.travel.editedRoute.itinerary.itineraryPoints.first.latLng:e.last?e.value.latLng=m.travel.editedRoute.itinerary.itineraryPoints.last.latLng:e.value.latLng=ze.getClosestLatLngDistance(m.travel.editedRoute,e.value.latLng).latLng;ze.endRouting()},o=function(){if(F)return!1;if(!m.travel.editedRoute.wayPoints.forEach(function(e,t){return null===t&&(t=!0),t&=0!==e.lat&&0!==e.lng}))return!1;F=!0;var o=m.providers.get(m.routing.provider.toLowerCase());return m.travel.editedRoute.itinerary.provider=o.name,m.travel.editedRoute.itinerary.transitMode=m.routing.transitMode,o.getPromiseRoute(m.travel.editedRoute,null).then(t,e),!0};return Object.seal({startRouting:function(){return o()}})},X=function(){var t=null,o=null,n=null,a=h(),r=function(e){if("Escape"===e.key||"Esc"===e.key){if(n&&!n())return;document.removeEventListener("keydown",r,!0),document.getElementsByTagName("body")[0].removeChild(document.getElementById("TravelNotes-BaseDialog-BackgroundDiv"))}},i=document.getElementsByTagName("body")[0],l=a.create("div",{id:"TravelNotes-BaseDialog-BackgroundDiv",className:"TravelNotes-BaseDialog-BackgroundDiv"},i);l.addEventListener("dragover",function(){},!1),l.addEventListener("drop",function(){},!1);var s=l.clientWidth,d=l.clientHeight,u=0,c=0,v=0,g=0,m=a.create("div",{id:"TravelNotes-BaseDialog-Container",className:"TravelNotes-BaseDialog-Container"},l),p=a.create("div",{id:"TravelNotes-BaseDialog-TopBar",className:"TravelNotes-BaseDialog-TopBar",draggable:!0},m);a.create("div",{innerHTML:"&#x274c",id:"TravelNotes-BaseDialog-CancelButton",title:e.getText("BaseDialog - Cancel")},p).addEventListener("click",function(){o&&!o()||(document.removeEventListener("keydown",r,!0),document.getElementsByTagName("body")[0].removeChild(l))},!1),p.addEventListener("dragstart",function(e){try{e.dataTransfer.setData("Text","1")}catch(e){console.log(e)}u=e.screenX,c=e.screenY},!1),p.addEventListener("dragend",function(e){v+=e.screenX-u,g+=e.screenY-c,v=Math.min(Math.max(v,20),s-m.clientWidth-20),g=Math.max(g,20);var t=d-Math.max(g,0)-20;m.setAttribute("style","top:"+g+"px;left:"+v+"px;max-height:"+t+"px;")},!1);var T=a.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv",id:"TravelNotes-BaseDialog-HeaderDiv"},m),f=a.create("div",{className:"TravelNotes-BaseDialog-ContentDiv",id:"TravelNotes-BaseDialog-ContentDiv"},m);a.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-BaseDialog-ErrorDivHidden",id:"TravelNotes-BaseDialog-ErrorDiv"},m);var N=a.create("div",{className:"TravelNotes-BaseDialog-FooterDiv",id:"TravelNotes-BaseDialog-FooterDiv"},m);return a.create("div",{innerHTML:"&#x1f4be;",id:"TravelNotes-BaseDialog-OkButton",className:"TravelNotes-BaseDialog-Button"},N).addEventListener("click",function(){t&&!t()||(document.removeEventListener("keydown",r,!0),document.getElementsByTagName("body")[0].removeChild(l))},!1),document.addEventListener("keydown",r,!0),{addClickOkButtonEventListener:function(e){t=e},addClickCancelButtonEventListener:function(e){o=e},addEscapeKeyEventListener:function(e){n=e},get title(){return T.innerHTML},set title(e){T.innerHTML=e},center:function(){v=(s-m.clientWidth)/2,g=(d-m.clientHeight)/2,v=Math.min(Math.max(v,20),s-m.clientWidth-20),g=Math.max(g,20);var e=d-Math.max(g,0)-20;m.setAttribute("style","top:"+g+"px;left:"+v+"px;max-height:"+e+"px;")},get header(){return T},set header(e){T=e},get content(){return f},set content(e){f=e},get footer(){return N},set footer(e){N=e}}},z=!1,V=function(){var e=L.latLng(0,0),o=0,n=null,a=null,r={},i=new Map,l=new Map,s=[],d=null,u=null,c=null,v=0,g=L.point(0,0),p=0,T=null,f=t.note.svgIconWidth,N=t.note.svgZoom,h=t.note.svgAngleDistance,y=null,b=null,I=[],E=function(){var t;i.clear(),l.clear(),r.elements.forEach(function(e){switch(e.type){case"area":e.tags&&e.tags.boundary&&e.tags.name&&(u=e.tags.name);break;case"way":e.nodesIds=e.nodes,delete e.nodes,i.set(e.id,e);break;case"node":l.set(e.id,e),e.tags&&e.tags.place&&["town","city","village","hamlet"].includes(e.tags.place)&&s.push(e)}}),(c=document.createElementNS("http://www.w3.org/2000/svg","svg")).setAttributeNS(null,"viewBox",f/4+" "+f/4+" "+f/2+" "+f/2),c.setAttributeNS(null,"class","TravelNotes-SvgIcon"),function(){var t=Number.MAX_VALUE,r=0;a.itinerary.itineraryPoints.forEach(function(a){var i=e.distanceTo(L.latLng(a.latLng));t>i&&(t=i,n=a,o=r),r+=a.distance}),e=L.latLng(n.latLng);var i=function(e){var t=!0;return a.wayPoints.forEach(function(o){Math.abs(e.lat-o.lat)<1e-5&&Math.abs(e.lng-o.lng)<1e-5&&(t=!1)}),t&&(n.lat!==e.lat||n.lng!==e.lng)};y=a.itinerary.itineraryPoints.previous(n.objId,i),b=a.itinerary.itineraryPoints.next(n.objId,i)}(),function(){var e=-1,t=-1,o=-1,a=Number.MAX_VALUE,r=Number.MAX_VALUE,s=Number.MAX_VALUE,d=0;l.forEach(function(i){n&&(d=L.latLng(i.lat,i.lon).distanceTo(L.latLng(n.lat,n.lng)))<a&&(e=i.id,a=d),y&&(d=L.latLng(i.lat,i.lon).distanceTo(L.latLng(y.lat,y.lng)))<r&&(t=i.id,r=d),b&&(d=L.latLng(i.lat,i.lon).distanceTo(L.latLng(b.lat,b.lng)))<s&&(o=i.id,s=d)});var u="",c="";i.forEach(function(n){var a=(n.tags.name?n.tags.name:"")+(n.tags.name&&n.tags.ref?" ":"")+(n.tags.ref?"["+n.tags.ref+"]":"");if(n.nodesIds.includes(e)){var r=n.nodesIds[0]===n.nodesIds[n.nodesIds.length-1],i=0!==n.nodesIds.indexOf(e)&&n.nodesIds.length-1!==n.nodesIds.lastIndexOf(e),l=n.nodesIds.includes(t),s=n.nodesIds.includes(o),d=""!==a;!i&&!l&&!s&&d&&I.push(a),(i&&d||r&&d)&&(l||s?(l&&!s||!l&&s)&&I.push(a):(I.push(a),I.push(a))),l&&(u=d?a:"???"),s&&(c=d?a:"???")}}),I.unshift(u),I.push(c)}(),t=Number.MAX_VALUE,s.forEach(function(e){var o=L.latLng(n.latLng).distanceTo(L.latLng(e.lat,e.lon));t>o&&(t=o,d=e.tags.name)}),g=L.point(f/2,f/2).subtract(m.map.project(e,N)),function(){var t=0,r=a.itinerary.itineraryPoints.first,i=a.itinerary.itineraryPoints.last,l=!1;a.itinerary.itineraryPoints.forEach(function(e){o-t>h&&(r=e),t-o>h&&!l&&(i=e,l=!0),t+=e.distance});var s=m.map.project(e,N).add(g);if(n.objId!==a.itinerary.itineraryPoints.first.objId){var d=m.map.project(L.latLng(r.latLng),N).add(g);0>(p=180*Math.atan((s.y-d.y)/(d.x-s.x))/Math.PI)&&(p+=360),p-=270,0>d.x-s.x&&(p+=180)}if(n.objId!==a.itinerary.itineraryPoints.last.objId){var u=m.map.project(L.latLng(i.latLng),N).add(g);for(T=180*Math.atan((s.y-u.y)/(u.x-s.x))/Math.PI,0>u.x-s.x&&(T+=180),T-=p;0>T;)T+=360;for(;360<T;)T-=360}n.objId===a.itinerary.itineraryPoints.first.objId&&(p=-T-90,T=null,v=-1),e.lat===a.itinerary.itineraryPoints.last.lat&&e.lng===a.itinerary.itineraryPoints.last.lng&&(T=null,v=1)}(),function(){var e=-1,t=-1,o=-1,n=[];if(a.itinerary.itineraryPoints.forEach(function(a){e++;var r=m.map.project(L.latLng(a.latLng),N).add(g);n.push(r),r.x>=0&&r.y>=0&&r.x<=f&&r.y<=f&&(-1===t&&(t=e),o=e)}),-1!==t&&-1!==o){0<t&&t--,a.itinerary.itineraryPoints.length-1>o&&o++;var r="";for(e=t;e<=o;e++)r+=n[e].x.toFixed(0)+","+n[e].y.toFixed(0)+" ";var i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",r),i.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),i.setAttributeNS(null,"transform","rotate("+p+","+f/2+","+f/2+")"),c.appendChild(i)}}(),i.forEach(function(e){var t=-1,o=-1,n=-1,a=[];if(e.nodesIds.forEach(function(e){n++;var r=l.get(e),i=m.map.project(L.latLng(r.lat,r.lon),N).add(g);a.push(i),i.x>=0&&i.y>=0&&i.x<=f&&i.y<=f&&(-1===t&&(t=n),o=n)}),-1!==t&&-1!==o){0<t&&t--,e.nodesIds.length-1>o&&o++;var r="";for(n=t;n<=o;n++)r+=a[n].x.toFixed(0)+","+a[n].y.toFixed(0)+" ";var i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",r),i.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),i.setAttributeNS(null,"transform","rotate("+p+","+f/2+","+f/2+")"),c.appendChild(i)}})},D=function(o,a){var i=new XMLHttpRequest;i.timeout=t.note.svgTimeOut,i.ontimeout=function(){a("TimeOut error")},i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){try{r=JSON.parse(i.responseText)}catch(e){z=!1,a("Parsing error")}E(),z=!1,o({svg:c,direction:T,startStop:v,city:u,place:d,streets:I,latLng:n.latLng})}else z=!1,a("Status : "+this.status+" statusText : "+this.statusText)};var l=e.lat.toFixed(6)+","+e.lng.toFixed(6),s=t.overpassApiUrl+"?data=[out:json][timeout:"+t.note.svgTimeOut+"];way[highway](around:"+(1.5*f).toFixed(0)+","+l+")->.a;(.a >;.a;)->.a;.a out;is_in("+l+')->.e;area.e[admin_level="2"][name="United Kingdom"]->.f;area.e[admin_level="8"]->.g;area.e[admin_level="10"]->.h;if(f.count(deriveds)==0){.g->.i;}else{if(h.count(deriveds)==0){.g->.i;}else{.h->.i;}}.i out;(node(area.i)[place="village"];node(area.i)[place="hamlet"];node(area.i)[place="city"];node(area.i)[place="town"];)->.k;( node(around:'+t.note.svgHamletDistance+","+l+')[place="hamlet"];node(around:'+t.note.svgVillageDistance+","+l+')[place="village"];node(around:'+t.note.svgCityDistance+","+l+')[place="city"];node(around:'+t.note.svgTownDistance+","+l+')[place="town"];)->.l;node.k.l->.m;.m out;';i.open("GET",s,!0),i.overrideMimeType("application/json"),i.send(null)};return Object.seal({getPromiseSvgIcon:function(t,o){return function(t,o){return z?Promise.reject():(z=!0,e=L.latLng(t),a=C().getRoute(o),r={},c=null,u=null,new Promise(D))}(t,o)}})},J=!1,K=function(){var e=-1,o=0,n=0,a=function(a,r){var i=new XMLHttpRequest;i.timeout=t.note.svgTimeOut,i.ontimeout=function(){r("TimeOut error")},i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){var t;J=!1;try{t=JSON.parse(this.responseText)}catch(e){J=!1,r("Parsing error")}J=!1,t.objId=e,a(t)}else J=!1,r("Status : "+this.status+" statusText : "+this.statusText)};var l=t.nominatim.url+"reverse?format=json&lat="+o+"&lon="+n+"&zoom=18&addressdetails=1",s=t.nominatim.language;s&&"*"!==s&&(l+="&accept-language="+s),i.open("GET",l,!0),s&&"*"===s&&i.setRequestHeader("accept-language",""),i.overrideMimeType("application/json"),i.send(null)};return Object.seal({getPromiseAddress:function(t,r,i){return function(t,r,i){return J?Promise.reject():(J=!0,e=i||-1,o=t,n=r,new Promise(a))}(t,r,i)}})},G={editionButtons:[],preDefinedIconsList:[]},Y={editionButtons:[],preDefinedIconsList:[]},Z={editionButtons:[],preDefinedIconsList:[]},Q=function(o,n,a){var r,i=null,l=null,s=null,d=h(),u=o.latLng,c="",v="",g=function(){return 0===document.getElementById("TravelNotes-NoteDialog-TextArea-IconHtmlContent").value.length?(document.getElementById("TravelNotes-BaseDialog-ErrorDiv").innerHTML=e.getText("Notedialog - The icon content cannot be empty"),document.getElementById("TravelNotes-BaseDialog-ErrorDiv").classList.remove("TravelNotes-BaseDialog-ErrorDivHidden"),!1):(o.iconWidth=document.getElementById("TravelNotes-NoteDialog-WidthNumberInput").value,o.iconHeight=document.getElementById("TravelNotes-NoteDialog-HeightNumberInput").value,o.iconContent=document.getElementById("TravelNotes-NoteDialog-TextArea-IconHtmlContent").value,o.popupContent=document.getElementById("TravelNotes-NoteDialog-TextArea-PopupContent").value,o.tooltipContent=document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value,o.address=document.getElementById("TravelNotes-NoteDialog-InputText-Adress").value,o.url=document.getElementById("TravelNotes-NoteDialog-InputText-Link").value,o.phone=document.getElementById("TravelNotes-NoteDialog-InputText-Phone").value,o.latLng=u,q.afterNoteDialog(o,n),!0)},m=function(e){c="",v="",e.address.house_number&&(c+=e.address.house_number+" "),e.address.road?c+=e.address.road+" ":e.address.pedestrian&&(c+=e.address.pedestrian+" "),e.address.village?v=e.address.village:e.address.town?v=e.address.town:e.address.city&&(v=e.address.city),""!==v&&(c+=t.note.cityPrefix+v+t.note.cityPostfix),0===c.length&&(c+=e.address.country),t.note.reverseGeocoding&&""===o.address&&a&&(document.getElementById("TravelNotes-NoteDialog-InputText-Adress").value=c)},p=function(o){document.getElementById("TravelNotes-NoteDialog-TextArea-IconHtmlContent").value=o.svg.outerHTML;var n="";if(null!==o.direction){var a=t.note.svgAnleMaxDirection;o.direction<a.right?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn right"),n=String.fromCodePoint(129154)):o.direction<a.slightRight?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn slight right"),n=String.fromCodePoint(129157)):o.direction<a.continue?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Continue"),n=String.fromCodePoint(129153)):o.direction<a.slightLeft?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn slight left"),n=String.fromCodePoint(129156)):o.direction<a.left?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn left"),n=String.fromCodePoint(129152)):o.direction<a.sharpLeft?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn sharp left"),n=String.fromCodePoint(129159)):o.direction<a.sharpRight?(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn sharp right"),n=String.fromCodePoint(129158)):(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Turn right"),n=String.fromCodePoint(129154))}-1===o.startStop?document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Start"):1===o.startStop&&(document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=e.getText("NoteDialog - Stop"));for(var r="",i=0,l=0;l<o.streets.length;l++)switch(0!==l&&o.streets.length-1!==l||""!==o.streets[l]?(r+=o.streets[l],i--):(r+="???",i++),l){case o.streets.length-2:r+=n;break;case o.streets.length-1:break;default:r+=String.fromCodePoint(10917)}o.city||""===v||(o.city=v),o.city&&(r+=" "+t.note.cityPrefix+o.city+t.note.cityPostfix),o.place&&o.place!==o.city&&2!==i&&(r+=" ("+o.place+")"),document.getElementById("TravelNotes-NoteDialog-InputText-Adress").value=r,document.getElementById("TravelNotes-BaseDialog-OkButton").style.visibility="visible",u=o.latLng},T=function(){document.getElementById("TravelNotes-BaseDialog-ErrorDiv").innerHTML=e.getText("Notedialog - an error occurs when creating the SVG icon"),document.getElementById("TravelNotes-BaseDialog-ErrorDiv").classList.remove("TravelNotes-BaseDialog-ErrorDivHidden"),document.getElementById("TravelNotes-BaseDialog-OkButton").style.visibility="visible"},f=function(t){var a=Z.preDefinedIconsList[t.target.selectedIndex];a.name===e.getText("NoteDialog - SVG icon from OSM")?(document.getElementById("TravelNotes-BaseDialog-OkButton").style.visibility="hidden",V().getPromiseSvgIcon(o.latLng,n).then(p,T)):(document.getElementById("TravelNotes-NoteDialog-WidthNumberInput").value=a.width,document.getElementById("TravelNotes-NoteDialog-HeightNumberInput").value=a.height,document.getElementById("TravelNotes-NoteDialog-TextArea-IconHtmlContent").value=a.icon,document.getElementById("TravelNotes-NoteDialog-InputText-Tooltip").value=a.tooltip)},N=function(e){if(s){for(var t=e.target;!t.htmlBefore;)t=t.parentNode;var o=t.htmlAfter&&0<t.htmlAfter.length,n=s.selectionStart,a=s.selectionEnd,r=s.value;s.value=r.substring(0,n)+(o?t.htmlBefore+r.substring(n,a)+t.htmlAfter:t.htmlBefore)+r.substring(a),s.setSelectionRange(o||n===a?n+t.htmlBefore.length:n,(o?a:n)+t.htmlBefore.length),s.focus()}},L=function(e){var t=new FileReader;t.onload=function(){try{var e=JSON.parse(t.result);G.editionButtons=G.editionButtons.concat(e.editionButtons),G.preDefinedIconsList=G.preDefinedIconsList.concat(e.preDefinedIconsList),I(e.editionButtons),b()}catch(e){console.log(e)}},t.readAsText(e.target.files[0])},y=function(e){s=e.target},b=function(){Z.preDefinedIconsList=Y.preDefinedIconsList.concat(G.preDefinedIconsList),-1<n&&Z.preDefinedIconsList.push({name:e.getText("NoteDialog - SVG icon from OSM"),icon:"",tooltip:"",width:40,height:40}),Z.preDefinedIconsList.sort(function(e,t){return e.name.localeCompare(t.name)});var t=0,o=document.getElementById("TravelNotes-NoteDialog-IconSelect");for(t=o.length-1;t>=0;t--)o.remove(t);for(t=0;t<Z.preDefinedIconsList.length;t++){var a=d.create("option",{text:Z.preDefinedIconsList[t].name});o.add(a)}},I=function(e){e.forEach(function(e){d.create("button",{type:"button",innerHTML:e.title||"?",htmlBefore:e.htmlBefore||"",htmlAfter:e.htmlAfter||"",className:"TravelNotes-NoteDialog-EditorButton"},document.getElementById("TravelNotes-NoteDialog-ToolbarDiv")).addEventListener("click",N,!1)})};(i=X()).title=e.getText("NoteDialog - Note"),i.addClickOkButtonEventListener(g),l=d.create("div",{id:"TravelNotes-NoteDialog-MainDataDiv"},i.content),function(){var t=d.create("div",{className:"TravelNotes-NoteDialog-ToolbarDiv",id:"TravelNotes-NoteDialog-ToolbarDiv"},l);d.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},t).addEventListener("change",f,!1);var o=d.create("div",{id:"TravelNotes-NoteDialog-OpenEditorFileDiv"},t),n=d.create("input",{id:"TravelNotes-NoteDialog-OpenEditorFileInput",type:"file",accept:".json"},o);n.addEventListener("change",L,!1);var a=d.create("div",{id:"TravelNotes-NoteDialog-OpenStyleFakeDiv"},o);d.create("button",{id:"TravelNotes-NoteDialog-OpenEditorFileButton",className:"TravelNotes-NoteDialog-EditorButton",title:e.getText("NoteDialog - Open a configuration file"),innerHTML:"&#x23CD;"},a).addEventListener("click",function(){n.click()},!1),I(Y.editionButtons),I(G.editionButtons),b()}(),r=d.create("div",{className:"TravelNotes-NoteDialog-DataDiv",id:"TravelNotes-NoteDialog-DimensionsDataDiv"},l),d.create("text",{data:e.getText("NoteDialog - Icon width")},r),d.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",id:"TravelNotes-NoteDialog-WidthNumberInput"},r).value=o.iconWidth,d.create("text",{data:e.getText("NoteDialog - Icon height")},r),d.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",id:"TravelNotes-NoteDialog-HeightNumberInput"},r).value=o.iconHeight,function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",id:"TravelNotes-NoteDialog-IconContentTitleDiv",innerHTML:e.getText("NoteDialog - Icon content")},l);var t=d.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",id:"TravelNotes-NoteDialog-TextArea-IconHtmlContent"},l);t.addEventListener("focus",y,!1),t.value=o.iconContent}(),function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",innerHTML:e.getText("NoteDialog - Text")},l);var t=d.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",id:"TravelNotes-NoteDialog-TextArea-PopupContent"},l);t.addEventListener("focus",y,!1),t.value=o.popupContent}(),function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",innerHTML:e.getText("NoteDialog - Tooltip content")},l);var t=d.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",id:"TravelNotes-NoteDialog-InputText-Tooltip"},l);t.addEventListener("focus",y,!1),t.value=o.tooltipContent}(),function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",innerHTML:"<span id='TravelNotes-NoteDialog-Reset-Address-Button'>&#x1f504;</span>&nbsp;"+e.getText("NoteDialog - Address&nbsp;:")},l),document.getElementById("TravelNotes-NoteDialog-Reset-Address-Button").addEventListener("click",function(){t.value=c},!1);var t=d.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",id:"TravelNotes-NoteDialog-InputText-Adress"},l);t.addEventListener("focus",y,!1),t.value=o.address,K().getPromiseAddress(o.lat,o.lng).then(m)}(),function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",innerHTML:e.getText("NoteDialog - Link")},l);var t=d.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",id:"TravelNotes-NoteDialog-InputText-Link"},l);t.addEventListener("focus",function(){s=null},!1),t.value=o.url}(),function(){d.create("div",{className:"TravelNotes-NoteDialog-TitleDiv",innerHTML:e.getText("NoteDialog - Phone")},l);var t=d.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",id:"TravelNotes-NoteDialog-InputText-Phone"},l);t.addEventListener("focus",y,!1),t.value=o.phone}(),function(){if(0===Y.preDefinedIconsList.length){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(this.readyState===e.DONE)if(200===this.status)try{Y=JSON.parse(this.responseText),I(Y.editionButtons),Y.preDefinedIconsList.push({name:"",icon:"",tooltip:"",width:40,height:40}),b()}catch(e){console.log("Error reading TravelNotesNoteDialog.json")}else console.log("Error sending request for TravelNotesNoteDialog"+t.language.toUpperCase()+".json")},e.open("GET",window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotesNoteDialog"+t.language.toUpperCase()+".json",!0),e.send(null)}}(),i.center()};let q=function(){let t=C();function o(e){let t=s();return t.latLng=e,t.iconLatLng=e,t}function n(){let e=m.travel.notes.iterator;for(;!e.done;)tt.removeObject(e.value.objId);let t=m.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)tt.removeObject(e.value.objId)}return Object.seal({newRouteNote:(e,n)=>(function(e,n){let a=ze.getClosestLatLngDistance(t.getRoute(e),[n.latlng.lat,n.latlng.lng]),r=o(a.latLng);r.distance=a.distance,Q(r,e,!0)})(e,n),newSearchNote:e=>(function(e){let t=o([e.lat,e.lon]);t.address=(e.tags["addr:housenumber"]?e.tags["addr:housenumber"]+" ":"")+(e.tags["addr:street"]?e.tags["addr:street"]+" ":"")+(e.tags["addr:city"]?e.tags["addr:city"]+" ":""),t.url=e.tags.website||"",t.phone=e.tags.phone||"",t.tooltipContent=e.tags.name||"",t.popupContent=e.tags.name||"",Q(t,-1,!0)})(e),newManeuverNote:(e,t)=>(function(e,t){let n=ze.getClosestLatLngDistance(m.travel.editedRoute,t),a=m.travel.editedRoute.itinerary.maneuvers.getAt(e),r=o(t);r.distance=n.distance,r.iconContent="<div class='TravelNotes-ManeuverNote TravelNotes-ManeuverNote-"+a.iconName+"'></div>",r.popupContent=a.instruction,r.iconWidth=40,r.iconHeight=40,Q(r,m.travel.editedRoute.objId,!0)})(e,t),newTravelNote:e=>(function(e){let t=o(e);Q(t,-1,!0)})(e),afterNoteDialog:(e,o)=>(function(e,o){let n=t.getNoteAndRoute(e.objId);if(n.note)tt.redrawNote(e),n.route?we().setItinerary():we().setTravelNotes();else{if(-1===o)m.travel.notes.add(e),we().setTravelNotes();else{let n=t.getRoute(o);n.notes.add(e),e.chainedDistance=n.chainedDistance,n.notes.sort((e,t)=>e.distance-t.distance),we().setItinerary()}tt.addNote(e)}at.updateRoadBook()})(e,o),editNote:e=>(function(e){let o=t.getNoteAndRoute(e);Q(o.note,null===o.route?-1:o.route.objId,!1)})(e),removeNote:e=>(function(e){tt.removeObject(e);let o=t.getNoteAndRoute(e);o.route?(o.route.notes.remove(e),we().updateItinerary()):(m.travel.notes.remove(e),we().updateTravelNotes()),at.updateRoadBook()})(e),hideNotes:()=>n(),showNotes:()=>(function(){n();let e=m.travel.notes.iterator;for(;!e.done;)tt.addNote(e.value);let t=m.travel.routes.iterator;for(;!t.done;)for(e=t.value.notes.iterator;!e.done;)tt.addNote(e.value)})(),zoomToNote:e=>(e=e,void tt.zoomToPoint(t.getNoteAndRoute(e).note.latLng)),attachNoteToRoute:e=>(function(e){let o=t.getNoteAndRoute(e),n=Number.MAX_VALUE,a=null,r=null,i=null;m.travel.routes.forEach(e=>{let t=ze.getClosestLatLngDistance(e,o.note.latLng);if(t){let l=L.latLng(o.note.latLng).distanceTo(L.latLng(t.latLng));l<n&&(n=l,a=e,r=t.latLng,i=t.distance)}}),a&&(m.travel.notes.remove(e),o.note.distance=i,o.note.latLng=r,o.note.chainedDistance=a.chainedDistance,a.notes.add(o.note),a.notes.sort((e,t)=>e.distance-t.distance),tt.redrawNote(o.note),we().updateItinerary(),we().updateTravelNotes(),at.updateRoadBook())})(e),detachNoteFromRoute:e=>(function(e){let o=t.getNoteAndRoute(e);o.route.notes.remove(e),o.note.distance=-1,o.note.chainedDistance=0,m.travel.notes.add(o.note),we().updateItinerary(),we().updateTravelNotes(),at.updateRoadBook()})(e),noteDropped:(e,t,o)=>(e=e,t=t,o=o,m.travel.notes.moveTo(e,t,o),we().updateTravelNotes(),void at.updateRoadBook()),getNoteHTML:(t,o)=>(function(t,o){let n="";0!==t.tooltipContent.length&&(n+='<div class="'+o+'NoteHtml-TooltipContent">'+t.tooltipContent+"</div>"),0!==t.popupContent.length&&(n+='<div class="'+o+'NoteHtml-PopupContent">'+t.popupContent+"</div>"),0!==t.address.length&&(n+='<div class="'+o+'NoteHtml-Address">'+e.getText("NoteEditor - Address")+t.address+"</div>"),0!==t.phone.length&&(n+='<div class="'+o+'NoteHtml-Phone">'+e.getText("NoteEditor - Phone")+t.phone+"</div>"),0!==t.url.length&&(n+='<div class="'+o+'NoteHtml-Url">'+e.getText("NoteEditor - Link")+'<a href="'+t.url+'" target="_blank">'+t.url.substr(0,40)+"...</a></div>");let a=g();return n+='<div class="'+o+'NoteHtml-LatLng">'+e.getText("NoteEditor - Latitude Longitude",{lat:a.formatLat(t.lat),lng:a.formatLng(t.lng)})+"</div>",-1!==t.distance&&(n+='<div class="'+o+'NoteHtml-Distance">'+e.getText("NoteEditor - Distance",{distance:a.formatDistance(t.chainedDistance+t.distance)})+"</div>"),n})(t,o)});var a,r,i,l}();var _=function(){var o=h(),a=g(),r=t.note.svgIconWidth,i="TravelNotes-Control-",l=function(e,t){var n=o.create("div",{className:i+"Travel-Notes-IconCell",innerHTML:e.iconContent},t);"svg"===n.firstChild.tagName&&"TravelNotes-Roadbook-"===i&&n.firstChild.setAttributeNS(null,"viewBox","0 0 "+r+" "+r),o.create("div",{className:i+"Travel-Notes-Cell",innerHTML:q.getNoteHTML(e,i)},t),t.noteObjId=e.objId},s=function(){var t=o.create("div",{className:i+"Travel-Header"});o.create("div",{className:i+"Travel-Header-Name",innerHTML:m.travel.name},t);for(var n=0,r=m.travel.routes.iterator;!r.done;)o.create("div",{className:i+"Travel-Header-RouteName",innerHTML:'<a href="#route'+r.value.objId+'">'+r.value.name+"</a>&nbsp;:&nbsp;"+a.formatDistance(r.value.distance)+"."},t),r.value.chain&&(n+=r.value.distance);return o.create("div",{className:i+"Travel-Header-TravelDistance",innerHTML:e.getText("HTMLViewsFactory - Travel distance&nbsp;:&nbsp;{distance}",{distance:a.formatDistance(n)})},t),t},d=function(){for(var e=o.create("div",{className:i+"Travel-Notes"}),t=m.travel.notes.iterator;!t.done;){var n=o.create("div",{className:i+"Travel-Notes-Row"},e);l(t.value,n)}return e},u=function(e){return o.create("div",{className:i+"Route-Header",id:"route"+e.objId,innerHTML:ze.getRouteHTML(e,i)})},c=function(t){for(var r=o.create("div",{className:i+"Route-ManeuversAndNotes"}),s=t.notes.iterator,d=s.done,u=d?Number.MAX_VALUE:s.value.distance,c=u,v=t.itinerary.maneuvers.iterator,g=v.done,m=0;!g||!d;){var p=o.create("div",{className:i+"Route-ManeuversAndNotes-Row"},r);if(m<=u){if(!g){p.className=i+"Route-Maneuvers-Row",o.create("div",{className:i+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+v.value.iconName},p);var T="<div>"+v.value.instruction+"</div>";0<v.value.distance&&(T+="<div>"+e.getText("HTMLViewsFactory - To next instruction&nbsp;:&nbsp;{distance}&nbsp;-&nbsp;{duration}",{distance:a.formatDistance(v.value.distance),duration:a.formatTime(v.value.duration)})+"</div>"),o.create("div",{className:i+"Route-ManeuversAndNotes-Cell",innerHTML:T},p),p.objId=n(),p.latLng=t.itinerary.itineraryPoints.getAt(v.value.itineraryPointObjId).latLng,p.maneuverObjId=v.value.objId,m+=v.value.distance,(g=v.done)&&(m=Number.MAX_VALUE)}}else if(!d&&(p.className=i+"Route-Notes-Row",l(s.value,p),p.objId=n(),p.latLng=s.value.latLng,p.noteObjId=s.value.objId,c=s.value.distance,u=(d=s.done)?Number.MAX_VALUE:s.value.distance,!d)){var f=s.value.distance-c;9<f&&o.create("div",{className:i+"NoteHtml-NextDistance",innerHTML:e.getText("HTMLViewsFactory - Next distance&nbsp;:&nbsp;{distance}",{distance:a.formatDistance(f)})},p.lastChild)}}return r},v=function(t){var n="";return""!==t.itinerary.provider&&""!==t.itinerary.transitMode&&(n=e.getText("HTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:t.itinerary.provider,transitMode:e.getText("HTMLViewsFactory - TransitMode "+t.itinerary.transitMode)})),o.create("div",{className:i+"RouteFooter",innerHTML:n})},p=function(){return o.create("div",{className:i+"TravelFooter",innerHTML:e.getText("HTMLViewsFactory - Travel footer")})};return Object.seal({set classNamePrefix(e){i=e},get classNamePrefix(){return i},get travelHeaderHTML(){return s()},get travelNotesHTML(){return d()},get routeHeaderHTML(){return u(m.travel.editedRoute)},get routeManeuversAndNotesHTML(){return c(m.travel.editedRoute)},get routeFooterHTML(){return v(m.travel.editedRoute)},get travelFooterHTML(){return p()},get travelHTML(){return function(){var e=o.create("div",{className:i+"Travel"});e.appendChild(s()),e.appendChild(d());for(var n=m.travel.routes.iterator;!n.done;){var a=t.routeEditor.displayEditionInHTMLPage&&n.value.objId===m.editedRouteObjId;e.appendChild(u(a?m.travel.editedRoute:n.value)),e.appendChild(c(a?m.travel.editedRoute:n.value)),e.appendChild(v(a?m.travel.editedRoute:n.value))}return e.appendChild(p()),e}()}})},$=0,ee=function(e){e.stopPropagation();try{e.dataTransfer.setData("Text",e.target.dataObjId),e.dataTransfer.dropEffect="move"}catch(e){console.log(e)}$=e.target.noteObjId-1},te=function(e){e.preventDefault()},oe=function(e){e.preventDefault();for(var t=e.target;!t.noteObjId;)t=t.parentElement;var o=t.getBoundingClientRect();q.noteDropped($+1,t.noteObjId,e.clientY-o.top<o.bottom-e.clientY)},ne=function(e){e.stopPropagation(),e.preventDefault();for(var t=e.target;!t.noteObjId;)t=t.parentNode;tt.zoomToNote(t.noteObjId)},ae=function(e){e.stopPropagation(),e.preventDefault();for(var t=e.target;!t.noteObjId;)t=t.parentNode;q.editNote(t.noteObjId)},re=function(){return Object.seal({remove:function(){!function(){var e=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(e){var t=e.firstChild;t&&(t.childNodes.forEach(function(e){e.removeEventListener("click",ne,!1),e.removeEventListener("contextmenu",ae,!1),e.removeEventListener("dragstart",ee,!1)}),e.removeChild(t))}}()},add:function(){!function(){document.getElementById("TravelNotes-Control-ItineraryPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton"),document.getElementById("TravelNotes-Control-TravelNotesPaneButton").classList.add("TravelNotes-Control-ActivePaneButton"),window.osmSearch&&document.getElementById("TravelNotes-Control-SearchPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton");var e=_();e.classNamePrefix="TravelNotes-Control-";var t=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(t){var o=e.travelNotesHTML;o.addEventListener("drop",oe,!1),o.addEventListener("dragover",te,!1),t.appendChild(o),o.childNodes.forEach(function(e){e.addEventListener("click",ne,!1),e.addEventListener("contextmenu",ae,!1),e.draggable=!0,e.addEventListener("dragstart",ee,!1),e.classList.add("TravelNotes-SortableList-MoveCursor")})}}()}})},ie=!1,le={searchPhrase:"",bbox:null},se=-1,de=-1,ue=window.osmSearch?window.osmSearch.searchLimits:null,ce=function(){le.bbox&&(-1!==se?tt.removeObject(se):se=n(),tt.addRectangle(se,L.latLngBounds(le.bbox.southWest,le.bbox.northEast),t.previousSearchLimit))},ve=function(e){m.searchData=e,ie=!1,ce(),we().updateSearch()},ge=function(e){console.log(e),ie=!1},me=function(){var e=m.map.getCenter();-1!==de?tt.removeObject(de):de=n(),tt.addRectangle(de,L.latLngBounds(L.latLng(e.lat-ue.lat,e.lng-ue.lng),L.latLng(e.lat+ue.lat,e.lng+ue.lng)),t.nextSearchLimit)},pe=Object.seal({search:function(){!function(){if(!ie){ie=!0;var e=m.map.getBounds();le={bbox:{southWest:e.getSouthWest(),northEast:e.getNorthEast()},searchPhrase:document.getElementById("TravelNotes-Control-SearchInput").value},m.searchData=[],window.osmSearch.getSearchPromise(le).then(ve,ge)}}()},show:function(){m.map.on("zoom",me),m.map.on("move",me),me(),ce()},hide:function(){m.map.off("zoom",me),m.map.off("move",me),-1!==de&&(tt.removeObject(de),de=-1),-1!==se&&(tt.removeObject(se),se=-1)}}),Te="",fe=function(e){"Enter"===e.key&&Ne()},Ne=function(){Te=document.getElementById("TravelNotes-Control-SearchInput").value;for(var e=document.getElementById("TravelNotes-Control-SearchDiv"),t=document.getElementsByClassName("TravelNotes-Control-SearchResult");0!==t.length;)t[0].removeEventListener("click",he,!1),t[0].removeEventListener("contextmenu",Le,!1),t[0].removeEventListener("mouseenter",ye,!1),t[0].removeEventListener("mouseleave",be,!1),e.removeChild(t[0]);if(!document.getElementById("TravelNotes-Control-SearchWaitBullet")){var o=h();o.create("div",{id:"TravelNotes-Control-SearchWaitBullet"},o.create("div",{id:"TravelNotes-Control-SearchWait"},e))}pe.search()},he=function(e){e.stopPropagation();for(var t=e.target;!t.latLng;)t=t.parentNode;tt.zoomToSearchResult(t.latLng,t.geometry)},Le=function(e){e.stopPropagation(),e.preventDefault();for(var t=e.target;!t.latLng;)t=t.parentNode;q.newSearchNote(t.searchResult)},ye=function(e){e.stopPropagation(),tt.addSearchPointMarker(e.target.objId,e.target.latLng,e.target.geometry)},be=function(e){e.stopPropagation(),tt.removeObject(e.target.objId)},Ie=function(){var t=h();return Object.seal({remove:function(){!function(){var e=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(e){pe.hide();var t=document.getElementById("TravelNotes-Control-SearchButton");t&&t.removeEventListener("click",Ne,!1);var o=document.getElementById("TravelNotes-Control-SearchInput");o&&o.removeEventListener("change",Ne,!1);var n=document.getElementById("TravelNotes-Control-SearchDiv"),a=document.getElementsByClassName("TravelNotes-Control-SearchResult");Array.prototype.forEach.call(a,function(e){e.removeEventListener("click",he,!1),e.removeEventListener("contextmenu",Le,!1),e.removeEventListener("mouseenter",ye,!1),e.removeEventListener("mouseleave",be,!1)}),n&&e.removeChild(n)}}()},add:function(){!function(){document.getElementById("TravelNotes-Control-ItineraryPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton"),document.getElementById("TravelNotes-Control-TravelNotesPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton"),document.getElementById("TravelNotes-Control-SearchPaneButton").classList.add("TravelNotes-Control-ActivePaneButton");var o=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(o){pe.show();var a=t.create("div",{id:"TravelNotes-Control-SearchDiv"},o);t.create("div",{id:"TravelNotes-Control-SearchButton",className:"TravelNotes-Control-Button",title:e.getText("SearchPaneUI - Search OpenStreetMap"),innerHTML:"&#x1f50e"},a).addEventListener("click",Ne,!1);var r=t.create("input",{type:"text",id:"TravelNotes-Control-SearchInput",placeholder:e.getText("SearchPaneUI - Search phrase"),value:Te},a);r.addEventListener("change",Ne,!1),r.addEventListener("keydown",fe,!1),r.focus();var i=0;m.searchData.forEach(function(e){var o=t.create("div",{id:"TravelNotes-Control-SearchResult"+i++,className:"TravelNotes-Control-SearchResult",innerHTML:(""!=e.description?"<p class='TravelNotes-Control-SearchResultDescription'>"+e.description+"</p>":"")+(e.tags.name?"<p>"+e.tags.name+"</p>":"")+(e.tags["addr:street"]?"<p>"+e.tags["addr:street"]+" "+(e.tags["addr:housenumber"]?e.tags["addr:housenumber"]:"")+"</p>":"")+(e.tags["addr:city"]?"<p>"+(e.tags["addr:postcode"]?e.tags["addr:postcode"]+" ":"")+e.tags["addr:city"]+"</p>":"")+(e.tags.phone?"<p>"+e.tags.phone+"</p>":"")+(e.tags.email?"<p><a href='mailto:"+e.tags.email+"'>"+e.tags.email+"</a></p>":"")+(e.tags.website?"<p><a href='"+e.tags.website+"' target='_blank'>"+e.tags.website+"</a></p>":"")+(e.ranking?"<p>&#x26ab;"+e.ranking+"</p>":"")},a);o.searchResult=e,o.objId=n(),o.osmId=e.id,o.latLng=L.latLng([e.lat,e.lon]),o.geometry=e.geometry,o.addEventListener("click",he,!1),o.addEventListener("contextmenu",Le,!1),o.addEventListener("mouseenter",ye,!1),o.addEventListener("mouseleave",be,!1)})}}()}})},Ce=function(e){e.stopPropagation();for(var t=e.target;!t.latLng;)t=t.parentNode;tt.zoomToPoint(t.latLng)},Ee=function(e){e.stopPropagation(),e.preventDefault();for(var t=e.target;!t.latLng;)t=t.parentNode;t.maneuverObjId?q.newManeuverNote(t.maneuverObjId,t.latLng):t.noteObjId&&q.editNote(t.noteObjId)},De=function(e){e.stopPropagation(),tt.addItineraryPointMarker(e.target.objId,e.target.latLng)},xe=function(e){e.stopPropagation(),tt.removeObject(e.target.objId)},Ae=function(){return Object.seal({remove:function(){!function(){var e=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(e){var t,o,n,a=document.getElementsByClassName("TravelNotes-Control-Route-Header")[0];a&&e.removeChild(a);var r=document.getElementsByClassName("TravelNotes-Control-Route-ManeuversAndNotes")[0];if(r){for(o=r.childNodes,t=0;t<o.length;t++)(n=o[t]).removeEventListener("click",Ce,!1),n.removeEventListener("contextmenu",Ee,!1),n.removeEventListener("mouseenter",De,!1),n.removeEventListener("mouseleave",xe,!1);e.removeChild(r)}}}()},add:function(){!function(){document.getElementById("TravelNotes-Control-ItineraryPaneButton").classList.add("TravelNotes-Control-ActivePaneButton"),document.getElementById("TravelNotes-Control-TravelNotesPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton"),window.osmSearch&&document.getElementById("TravelNotes-Control-SearchPaneButton").classList.remove("TravelNotes-Control-ActivePaneButton");var e=_();e.classNamePrefix="TravelNotes-Control-";var t=document.getElementById("TravelNotes-Control-ItineraryDataDiv");if(t){var o,n,a;t.appendChild(e.routeHeaderHTML),t.appendChild(e.routeManeuversAndNotesHTML);var r=document.getElementsByClassName("TravelNotes-Control-Route-ManeuversAndNotes")[0];if(r)for(n=r.childNodes,o=0;o<n.length;o++)(a=n[o]).addEventListener("click",Ce,!1),a.addEventListener("contextmenu",Ee,!1),a.addEventListener("mouseenter",De,!1),a.addEventListener("mouseleave",xe,!1)}}()}})},Re=-1,Be=function(e){e.deltaY&&(e.target.scrollTop=e.target.scrollTop+10*e.deltaY),e.stopPropagation()},je=function(){we().setItinerary()},Me=function(){we().setTravelNotes()},Pe=function(){we().setSearch()},we=function(){var t=re(),o=Ie(),n=Ae(),a=function(){switch(Re){case 0:n.remove();break;case 1:t.remove();break;case 2:window.osmSearch&&o.remove()}};return Object.seal({createUI:function(t){!function(t){if(!document.getElementById("TravelNotes-Control-ItineraryDataDiv")){var o=h(),n=o.create("div",{id:"TravelNotes-Control-ItineraryHeaderDiv",className:"TravelNotes-Control-HeaderDiv"},t);o.create("div",{innerHTML:e.getText("DataPanesUI - Itinerary"),id:"TravelNotes-Control-ItineraryPaneButton",className:"TravelNotes-Control-PaneButton"},n).addEventListener("click",je,!1),o.create("div",{innerHTML:e.getText("DataPanesUI - Travel notes"),id:"TravelNotes-Control-TravelNotesPaneButton",className:"TravelNotes-Control-PaneButton"},n).addEventListener("click",Me,!1),window.osmSearch&&o.create("div",{innerHTML:e.getText("DataPanesUI - Search"),id:"TravelNotes-Control-SearchPaneButton",className:"TravelNotes-Control-PaneButton"},n).addEventListener("click",Pe,!1),o.create("div",{id:"TravelNotes-Control-ItineraryDataDiv",className:"TravelNotes-Control-DataDiv"},t).addEventListener("wheel",Be,!1)}}(t)},setItinerary:function(){a(),n.add(),Re=0},updateItinerary:function(){0===Re&&(n.remove(),n.add())},setTravelNotes:function(){a(),t.add(),Re=1},updateTravelNotes:function(){1===Re&&(t.remove(),t.add())},setSearch:function(){a(),o.add(),Re=2},updateSearch:function(){2===Re&&(o.remove(),o.add())}})},Se=function(){var e=null,t=h(),o=!1,n=null,a=null,r=null,i=null,l=function(e){m.routing.provider=e,document.getElementsByClassName("TravelNotes-Control-ActiveProviderImgButton")[0].classList.remove("TravelNotes-Control-ActiveProviderImgButton"),document.getElementById("TravelNotes-Control-"+e+"ImgButton").classList.add("TravelNotes-Control-ActiveProviderImgButton");var t=m.providers.get(e.toLowerCase());t.transitModes.car?document.getElementById("TravelNotes-Control-carImgButton").classList.remove("TravelNotes-Control-InactiveTransitModeImgButton"):document.getElementById("TravelNotes-Control-carImgButton").classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),t.transitModes.bike?document.getElementById("TravelNotes-Control-bikeImgButton").classList.remove("TravelNotes-Control-InactiveTransitModeImgButton"):document.getElementById("TravelNotes-Control-bikeImgButton").classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),t.transitModes.pedestrian?document.getElementById("TravelNotes-Control-pedestrianImgButton").classList.remove("TravelNotes-Control-InactiveTransitModeImgButton"):document.getElementById("TravelNotes-Control-pedestrianImgButton").classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),t.transitModes.train?document.getElementById("TravelNotes-Control-trainImgButton").classList.remove("TravelNotes-Control-InactiveTransitModeImgButton"):document.getElementById("TravelNotes-Control-trainImgButton").classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),m.providers.get(e.toLowerCase()).transitModes[m.routing.transitMode]||(t.transitModes.bike?d("bike"):t.transitModes.pedestrian?d("pedestrian"):t.transitModes.car?d("car"):t.transitModes.train&&d("train"))},s=function(e){e.stopPropagation(),l(e.target.provider),ze.startRouting()},d=function(e){m.routing.transitMode=e,document.getElementsByClassName("TravelNotes-Control-ActiveTransitModeImgButton")[0].classList.remove("TravelNotes-Control-ActiveTransitModeImgButton"),document.getElementById("TravelNotes-Control-"+e+"ImgButton").classList.add("TravelNotes-Control-ActiveTransitModeImgButton")},u=function(e){e.stopPropagation(),d(e.target.transitMode),ze.startRouting()},c=function(l){var d=t.create("img",{src:"data:image/png;base64,"+l.icon,id:"TravelNotes-Control-"+l.name+"ImgButton",className:"TravelNotes-Control-ImgButton",title:l.name},e);d.provider=l.name,d.addEventListener("click",s,!1),o||(d.classList.add("TravelNotes-Control-ActiveProviderImgButton"),m.routing.provider=d.provider,o=!0,l.transitModes.bike?(n.classList.add("TravelNotes-Control-ActiveTransitModeImgButton"),m.routing.transitMode="bike"):l.transitModes.pedestrian?(a.classList.add("TravelNotes-Control-ActiveTransitModeImgButton"),m.routing.transitMode="pedestrian"):l.transitModes.car?(r.classList.add("TravelNotes-Control-ActiveTransitModeImgButton"),m.routing.transitMode="car"):l.transitModes.train&&(i.classList.add("TravelNotes-Control-ActiveTransitModeImgButton"),m.routing.transitMode="train"),l.transitModes.car||r.classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),l.transitModes.pedestrian||a.classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),l.transitModes.bike||n.classList.add("TravelNotes-Control-InactiveTransitModeImgButton"),l.transitModes.train||i.classList.add("TravelNotes-Control-InactiveTransitModeImgButton"))},v=function(l){e=t.create("div",{id:"TravelNotes-Control-ItineraryButtonsDiv",className:"TravelNotes-Control-ButtonsDiv"},l),(n=t.create("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AoaESkaC0SxrgAABMdJREFUSMfNl1loVGcYhp//n+WcZmbiJE4WjVKVaLWOGxglilFTSmYUF1ILKiIILSjplQiKS65EXG4UvBGrQvVCUAdjoRrEGmtwjQbtWKlpEsTGGDMxkzKTzHr+XiRucbK4ts/lOd/5X853vuU9gj4YN+48Dx58DUBOzrmhnZ0qXykWJBKqKJlkYjyusgAsFtFqMnHPbBa/CcEvaWnir5YWT1vvM3ojUl2cPv1XamqK8fv/MBcWPtwfDhuLlWKYUvSLECAEzTabPHP16uc/uN1fJp6fNShhpRROZ+WSzk7jVDyuTLwDFotIpqXJb4LBkgohRP/Cbvc5/H6krhsnolFVOtAbDoQQoGnCF4nIb91uDL/f8+KefDXQ70e6XOpIJPL+ot2Zg0hElbpc6ojf/7qWBPB6q1FKoevqRCBgrOYDEwgYq3VdnVBK4fVWd2cjL6+SpqYSnM5zi4PBZAUfEafTtCQY9JzJy6tENjWVsH79ZWs4bJziIxMOG6fWr79sbWoq6S4uTTt7MBo1vuMToGnyx2jU+71ITz/rCoWM3w2D3AFKBUj0NIL5nYWl5IndLidJw2CsUgOJwtSp6SQSC7h5czZO50vhIUPMTJrkYMIEO8OHa4Op9FzDYKyUEs9gWqelJUpbm8GcOdcJBmOAARjEYgZFRUOoqZnNyJGDEkZKPOZIRM0bTIricUU8blBePhaQKAXJZBzDUMyYkcnly21cvx7sPRpSEomoeWZgQv9hSUAxYoSD8+efsmdPIxkZVgBMJrDZTKxdO4YLF56Sm/sZT5509jzX76SdYI7FurdMKoqKMti8eQyZmVakFOTkaGzaFGP79gZCoSSaJpk82UFl5VN2727k+PEpxGIGHR0Jdu5s4Natf1KeG4uprD7Lc86cDPbuHc/y5Xd4/DhKa+tXNDZ2cfJkC9euFXLw4EMMA6ZNG8KOHfUcPjyZKVPSWbnyNg0NEXy+aaxadYcbN1KLS6tVtKZK75YtY1ix4i51dZ0sWpTF3bshurqSZGdruN3VLFyYS3HxUEKhJAsXZpGbq1Faeovt28dz716IpUtvs21bfs+neh2rVbSagftAVu+edTotdHUl0XVJdraV+fOvcejQJPLzbSj1lHXr/GiapL09gc83lWg0ycyZDk6ffozNZiIUSpKdbe3p/ze4LzVNVKVIBJcuteHxuOjqSrJvXyNpaSaKi134fM2AoL6+C6/Xxf79X7Bx45/Y7RZ27XpIeXkdoVCcuXMzuXIldZVrmqgSdvvZwnDYuNK7l9PTzVRVzUAIQV1dmLlzh7Jhw32OHm16ZY0r8vPTSCQUXm8WW7fmc/p0C263g5wcK7NmXePZs/gbO9pmk7MGGJkJvN5cRo9O4+efW3j0KNKXaQEMJk50sGzZMOrrwxw79nfKlno+MgexJFR/Lumt458vCQlQVmYvs1hEgj79oHiLNdB3vMUiEmVl9rL/3gh4vdW0t5ec0XXp+1iiui597e0lZ7zeal4YgZecky6XOvKhfZfLJX8KBMQa8BgpXabbjREIiDW6LnxCvL+gEKDrwhcIiDVuN8b/wtCnXJ4FBRfp6PBU1NaO0h0OeUBKmgeTASFASpodDnmgtnaU3tHhqSgouDj4f6dP8dP2L6C7Ld6Z4dDBAAAAAElFTkSuQmCC",id:"TravelNotes-Control-bikeImgButton",className:"TravelNotes-Control-ImgButton"},e)).transitMode="bike",n.addEventListener("click",u,!1),(a=t.create("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AoaESo7bADyMwAABNlJREFUSMe1V19oU1cY/52Te5Ob3DR/SfzTNNCufxRXxmarONCnPbi+ykYrFdRSkeJLX5ykZcKcFfG5oIJ2Y2sVFZQ+iPoiUhC128OIiJrUlgQTm9o0t23SJufmnj2k2ura5syx7ynknu/7nd93vr8E6wghBJxzAEAgAEsmc3pToWD1y3L6M8NQfABA6eIUY54xs3kh5Xb3JONx5D/WXdX2Wh9crkPIZAbAOVBRcbpvYaHuO87lDZyTCs7lFaochDAQwucANmmzRa7PzfWECFm2IQTsdrdiZuYqHI5quVg80J7P113WdR+AIsTEBEmagsUSOayq539PpVLM5WpFJnO1POOtW+GMRH4dKRa9jZxTABz/TggIMSDLU+Fg8NDuaBTaxyfoux8ORxsAwG7vrI5Ehl7pur+Rc/IJoCX3c05QKGxsnJgYemW3d1avxPgH42AQzkRi6JWuOz3ljReX7k3KnpQkLb158/6aWGyZOS0F0kF4vX45mRwY0XV3WdCGBhsePvwa3d1BAEZZYF13e5LJgRGv1y87nQdLjCmlMAwDqvrj4Wx2x6XyDAw8eLADe/b4AQCqehu5nJj7bbYnHbncT5cppaCGYYBzIJ+vu7TiydcNnP7+GBKJRQwPJ5HL6YLvTlEo1F3iHDAMo4Rkt5/qK6UMFwK+du0NurvDePt2EQ0NdkE9Dl33wW4/1QcApKoKltevrz01DLVWNGKbmhwYHd1dCrEiR0vLY9y7Ny0UaJRmo5WV339OZ2b6NgGyXzRRVFXC4OCXKwwBd+/uRH//VkHmsn9mpm8TZUzxcU4comzb2zciEFCg6yWQZ8/mcOJEGF1dNaivV8tb4MTBmOKjkpSuLdXe8lJZacb5819g374/QEiphJpMBGfPvlxiTwSAZUjSdC0tdZnyCiYTwfBwMx49SuPOnSkA7P3/7/QZM4SC0zCsPkn0bX0+GU+eTCMUGgNAcO7cGEwmCbOzFITI2Lv3ESYmFsWruar2tmWzu4bEjhtLxY4jn/8G2ayByck8mpsfY36+CPEAfbif6ronSggTLgKAgQsXtmF+nuLIkTC2bHGhpcUj3EwIYdB1b5TK8uIUIXxW9LbBoBXt7VW4ciWOGzeSuHnzNQYHvxJ3MeGzZvPiFHW7Q0mApcTUiujtrYHVChw79hyAjOPHX6JYJLh4cZtQwyCEpVyuUJLG48hbrS+uA6aySvX1Kjo7q9HV9fS9a6PRHG7dSqCtLYBAwFp2OlGUF9fjceRJKbcAWf6N67p3zbciBBgZ2Ym6OjsaGh4gk1luDmYzQT7/LUKhZzhzZnyN0kkgSdNg7AAhBKCUUhACWCyRjvVc1dxcgV273Dh58jkymQ+DsVAwcPToX1AUsm5GmM2RjiXQ0tVcroMAbsvZ7Nk/GdvYuNoF/H4ZGzZYEA7PrcpIUSgoBXI5Y9VskOU3Yafzh+2MtTBN++W/jD7iIklauqpqf834+Eejz7tBLBaDpij3myRJS4sNBeXzXpK0tKLcbxofh+Z0tq0/3tbWwhmLDYww5vv/x9vlDaIV0Sg0jye03WYbPSxJ0xBJtQ8H+mlus412eDwntkej0Fyu1k9dYX7uW1ioX3OFoZQB4HOEsEmr9RNXmLWWtspKWDRt9aVN1z1jsryQcjh6komE2NL2N0SHF0QJfjNNAAAAAElFTkSuQmCC",id:"TravelNotes-Control-pedestrianImgButton",className:"TravelNotes-Control-ImgButton"},e)).transitMode="pedestrian",a.addEventListener("click",u,!1),(r=t.create("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AoaESgBmDpJAwAABQBJREFUSMe9V09MFFcY/703szOz7PLP2WVBV6rtdm21HqhG2wiCh8bL2jWhsl71IhqJJ4oHL4RIxKP1HzESLh4MEGPkoAeNYRWtGkPShGRF+aeFld2psd0BZnZmXg+LW4SdrW3EX/Iub775fe/7977vEdigrCyMmZnrAABZbvGoavkGSh0hy3LtNAzuS57nZAAwTVPhOHOEUnXAstL9Ltd0TFFOJ5dyLAXJtSnLMhRFwaNHoDt3nj2v66vDjHHljDkAsIXf2CKKzB4haRBixgVh6vrAwNEj27bB8ng8SCaTH6aYMcDtPh3StM/6DKNIACz8N1Dw/J+6KI7Xp1It/YTkkliEwsJmnD8PIopdvbOzX90wDPf/UAoAFgzDLczOfn1Dkrp6T5wAKSpqtre4tRXk5MkLV3W9ch8+IgRhsqel5XCkrS0bn4xiWZaRTCqQpK5eTfPVYwUgiq/75ucP/uT1ZmJOvd4wFEWBy9UR0nXPiigFAF331LtcHaFkMomysnDG4mgUdNeuq3OZmK4ceD6lP34ccVZVwSIZN5y9qGlfHLJPJAa/X4LbzeUlnp21MDk5Z1csAChE8XmnpjU1Eln+2fPmzXe/WZZYbkcoyxympn6AaaahKCrIkvpgjKGkpACSJCAQuI2JibR9oVEtXlz862ZeVSs2MMaV57NkzRoHBIFi06aHGB5+m/XC4sIIBAoxMrILfr+YVzFjXPncXPkGSikfytxIeapyIQKHDlUAAIJBN3p7t+Lata0IBt0AGBobVy/IsrxcjDlACL+Htyx3zT+nz3GnEqCyUkJ39wSOHYvh7t1vUVvrz37fu3cNotHfUVs7BElywO+XAKj5VIMxdw01TS5onwwWHjzYjp6ebaiokFBdXYJUSl8mNT9voq6uBH6/hO7uLXjy5HtQamsKTJMLUo7j5NwWMxw44Mf27TIKCnjs3u1DNFqDVGq5bDJp4M6dHQiHV6OggMeWLaU4enQt7Hg5jltF88WjqIjPNo13aGj4fJnc/v3r32swAFBcnD9vqGmaSm5XE5w58xINDYMgBKiru4ebN+NIpxlGR1WMjWXW6KgKTbMwOKigunoAhACHDz/CqVNjsOM1TVPhBOHHsGG4KnOfK41z577BunWFcDgscByDzyfh9u04Xr5UMTmZWT6fhFevVAQCBaiqKkVpKYfLl6fzNI3UEE9pKgr4duSOB0EqZQAAVNXAyIiKp0/fgudJ1qWEAJcujYEQAll2LMiaiwaG5ZyEpKK8ZRn9hKSPM8bnul3R1TWJUGgtLlyYwtDQX3njtn69E01NQVy58gqMEZvyTIMxo586ndMxQsy4Hdn4eBr37ycwPj6/YIH9mprScO9eAs+eaXnuBTPudE7HFprELxc1LZCnSVhLh5W804e9LIUgPO/U9aZGAgDDw6CbN1+dM82VbYscl9JjsYgzEIBFy8rC2LgRlihO1BNirphSQkyI4nh9IAArOwh4vV7MzCQ+7egDAIlEAoQAra0H9wnCRM/HVioIEz2trQf3EYLsjP1eFrS3N7Pjx49ERPF138dwe8a9r/va2o5E2tub2QcO9B0hTVv3aQb6d/B4ZKhqS/+tWxGnJL3opFSLE2IsOifJcXYCQgxQqsUl6UXn4GDEqaot/V6v58PfTpmECyORWPpo4/dYlrvGMLggz3OrFh5tf1BqPuO4VNSyjBsuVzymKB3/+mj7G1dPIltjqpC6AAAAAElFTkSuQmCC",id:"TravelNotes-Control-carImgButton",className:"TravelNotes-Control-ImgButton"},e)).transitMode="car",r.addEventListener("click",u,!1),(i=t.create("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4goTCiEjvCsRvgAABXRJREFUSMe9V11MFFcU/u7MsDPLrgvu7A80BEhLsRIxEFIlcSXBF41BN2ExqC8kPHQraV80iA+GhKAYaLUihkLaaErig1FCiCZq2kQDjS0YfcGYQKtBg7DL7hbFHdaZnTu3D0tR7C7aRvxeJrn3zP3O3z3nXIIUcLm8mJ0dBADIcpNDUbLWcVxalWFYKnSd/1QQeBkAKKURnqd/cJwyZBjxqxbLzHgk0hF+84w3QZItyrKMSCSC0VFwFRVnuzXtIy9jfBZjaQDY4m/stSMSa4TEQQgNmEzTg0NDXzVs2gTD4XAgHA6/GzFjgNXaUaWqef26bjMBBv4bOAjCvCaKk75otOkqIckkXsOaNY3o7gYRxXOXFxY+u6Lr1v9BCgAGdN1qWlhYf0WSzl0+ehTEZmtMbXFLC8jx499f1LTcPXiPMJmeXGpqOlDb2roUnwSxLMsIhyOQpHOXVdXtwypAFIP9L1/W1zidiZhzTqcXkUgEFkt7laY5VoUUADTN4bNY2qvC4TBcLm/C4uFhcJWVF2OJmK4eBCGq3blTay4thUESbjjbo6qf+JMlks3GYX7egNfrgtv9A+bn55Geng673Y7du3eD0iL4/ffx6JECm03A3JwOxlJnuyj+2auqX3/Jy/Jhh6Ks72SMtyZPDAJNY9i40Yq+vi9QU1OD6elp5OXlIRgMorp6C4qL14BSBkWhCAY1CAJgJL0MDIyl52Rm5v8kKEr2Osb4rJQXw0iob7ebMDIygvLy8qW9/Px89PT0oKSkBGfOfItTpwK4fz8KWU5DMBhH8hrBZ8ViWes4jhOqEhUpORwOEW63Cdu2CSgvL8fY2BgYY2CMobOzEzt27IDD4UBnZydevEi42WYTUp7HWBoIEXYJhmHd+qr8/Rvd3RuQns5j374NOH/+PLKzs9HX1wdCCOx2O+rq6pCTkwNN00AIQSCgYnx8AUAsFTUYs24VKOULl9fe5XjyJIbm5s9x4sQJlJSUwO12g1KaUtHe3l7k5lbg3r35FBIElPKFHM/z8koWHzu2BUNDQ7h27RpKS0tXJAUAv9+Pykr7ChIMPM/bhbfdPb/fj4GBAfT39y+tud1ubN68GRkZGQiFQpiamsKzZ8+gKApisRhGR/sAFK18pymlEYA4U1lNKUVlZSUuXLiA7du3w25fbg1J0nri8Tiam39ewdU0IvA8nYjHmTOVZnv37kVhYSE8Hg/YYmX45zs5OYmZmRmUlZVBkqTF0qhB1/W3uJpOcBwXHU7RlgEA1dXV4HkegiDgwIEGdHR8A13XQQjBxMQEPB4P2tvbl+T379+PgwcPrUBMQEh0mEjSd1tU9eNfGUse7p07HcjOlvD0aRPMZjMGBgaW9nw+HyoqKqAoCjRNA6UUU1NTuH79OmZmfkxOS3SI4iMPWbv2sOP58/IxwxBTVi9CgPr6HITDzXC5XJAkCV1dXSltOnToF5w8qSav1pwayMj4vViYm+sIi2LXoKoWJG0SZjOBIHAoK7OB484gM/M31NXV4e7du7h5U0Ju7gzM5hhu3bqFkZEReDzHcfr0wgoj0dPBubmOMAGABw/AFRdfjFG6um2R56Pa+HituaAABudyeVFUBEMUH/sIoatGSgiFKE76CgpgLA0CTqcTs7OhDzv6AEAoFAIhQEtL/R6T6fGl901qMj2+1NJSv4cQLM3Yy8bbtrZGduRIQ60oBvvfh9sT7g32t7Y21La1NbJ3HOjbq1Q1/8MM9K+avwxFabp640atWZIe9nKcGiBEf01PkkR3AkJ0cJwakKSHvbdv15oVpemq0+l497dTIuG8CIXefLQJuwzDulXX+UJB4O2LTeQvjqMTPB8dNgz9isUSGI9E2t/6aPsbwfNWty4y/a8AAAAASUVORK5CYII=",id:"TravelNotes-Control-trainImgButton",className:"TravelNotes-Control-ImgButton"},e)).transitMode="train",i.addEventListener("click",u,!1),m.providers&&(o=!1,m.providers.forEach(c))};return Object.seal({createUI:function(e){v(e)},get provider(){return m.routing.provider},set provider(e){l(e)},get transitMode(){return m.routing.transitMode},set transitMode(e){d(e)}})},Oe=function(){var t=!1,o="",n=!1,a={},r=function(e){e.itinerary.itineraryPoints.latLngs=p.decode(e.itinerary.itineraryPoints.latLngs,6);var t=[],o=0;e.itinerary.itineraryPoints.latLngs.forEach(function(n){var a={};a.lat=n[0],a.lng=n[1],a.distance=e.itinerary.itineraryPoints.distances[o],a.objId=e.itinerary.itineraryPoints.objIds[o],a.objType=e.itinerary.itineraryPoints.objType,t.push(a),o++}),e.itinerary.itineraryPoints=t},i=function(){a.routes.forEach(r),a.editedRoute&&r(a.editedRoute),t?l():s()},l=function(){var e=v();e.object=a;for(var t=e.routes.iterator;!t.done;)m.travel.routes.add(t.value);for(var o=e.notes.iterator;!o.done;)m.travel.notes.add(o.value);ze.chainRoutes(),d()},s=function(){m.travel.object=a,m.editedRouteObjId=-1,""!==o&&(m.travel.name=o.substr(0,o.lastIndexOf("."))),m.travel.readOnly=n,m.travel.routes.forEach(function(e){0!==e.edited&&(m.editedRouteObjId=e.objId)}),d()},d=function(){tt.removeAllObjects();for(var t=m.travel.routes.iterator;!t.done;)0===t.value.edited&&tt.addRoute(t.value,!0,!1,n);-1!==m.editedRouteObjId&&tt.addRoute(m.travel.editedRoute,!0,!n,n);for(var o=m.travel.notes.iterator;!o.done;)tt.addNote(o.value,n);if(tt.zoomToTravel(),n)document.getElementById("TravelNotes-Control-MainDiv").classList.add("TravelNotes-Control-MainDiv-Hidden"),document.getElementById("TravelNotes-Control-MainDiv").classList.remove("TravelNotes-Control-MainDiv-Maximize"),document.getElementById("TravelNotes-Control-MainDiv").classList.remove("TravelNotes-Control-MainDiv-Minimize");else{if(-1!==m.editedRouteObjId){var a=m.travel.editedRoute.itinerary.provider;if(a&&""!==a&&!m.providers.get(a.toLowerCase()))I.showError(e.getText("FileLoader - Not possible to select as provider",{provider:a}));else{var r=m.travel.editedRoute.itinerary.transitMode,i=Se();i.provider=a,r&&""!==r&&(i.transitMode=r)}ze.chainRoutes();var l=U();l.expand(),l.setWayPointsList(),we().setItinerary()}at.updateRoadBook(!1)}m.map.fire("travelnotesfileloaded",{readOnly:n,name:m.travel.name})},u=function(e){o=e.target.files[0].name;var t=new FileReader;t.onload=function(){try{a=JSON.parse(t.result),i()}catch(e){console.log(e)}},t.readAsText(e.target.files[0])};return Object.seal({openLocalFile:function(e){!function(e){t=!1,n=!1,u(e)}(e)},mergeLocalFile:function(e){!function(e){t=!0,n=!1,u(e)}(e)},openDistantFile:function(e){!function(e){L.travelNotes.rightContextMenu=!1,n=!0,a=e,i()}(e)}})},He=null,ke=function(){var o=null,n=function(){o&&(clearTimeout(o),o=null),document.getElementById("TravelNotes-Control-MainDiv").classList.remove("TravelNotes-Control-MainDiv-Minimize"),document.getElementById("TravelNotes-Control-MainDiv").classList.add("TravelNotes-Control-MainDiv-Maximize")},a=function(){document.getElementById("TravelNotes-Control-MainDiv").classList.remove("TravelNotes-Control-MainDiv-Maximize"),document.getElementById("TravelNotes-Control-MainDiv").classList.add("TravelNotes-Control-MainDiv-Minimize")},r=function(){o=setTimeout(a,t.travelEditor.timeout)},i=function(t){t.stopPropagation(),document.getElementById("TravelNotes-Control-TravelHeaderDiv").classList.toggle("TravelNotes-Control-SmallHeader"),document.getElementById("TravelNotes-Control-TravelDataDiv").classList.toggle("TravelNotes-Control-HiddenList"),document.getElementById("TravelNotes-ControlTravelButtonsDiv").classList.toggle("TravelNotes-Control-HiddenList");var o=document.getElementById("TravelNotes-Control-TravelDataDiv").classList.contains("TravelNotes-Control-HiddenList");document.getElementById("TravelNotes-ControlTravelExpandButton").innerHTML=o?"&#x25b6;":"&#x25bc;",document.getElementById("TravelNotes-ControlTravelExpandButton").title=o?e.getText("TravelEditorUI - Show"):e.getText("TravelEditorUI - Hide"),t.stopPropagation()},l=function(e){var t=document.getElementById("TravelNotes-Control-MainDiv");10060===e.target.innerHTML.charCodeAt(0)?(e.target.innerHTML="&#x1f4cc;",t.addEventListener("mouseenter",n,!1),t.addEventListener("mouseleave",r,!1)):(e.target.innerHTML="&#x274c;",t.removeEventListener("mouseenter",n,!1),t.removeEventListener("mouseleave",r,!1))},s=function(e){e.stopPropagation(),at.removeRoute(e.itemNode.dataObjId)},d=function(e){e.stopPropagation(),at.swapRoute(e.itemNode.dataObjId,!0)},u=function(e){e.stopPropagation(),at.swapRoute(e.itemNode.dataObjId,!1)},c=function(e){e.stopPropagation(),at.editRoute(e.itemNode.dataObjId)},v=function(e){e.stopPropagation(),at.renameRoute(e.dataObjId,e.changeValue)},g=function(e){e.stopPropagation(),at.routeDropped(e.draggedObjId,e.targetObjId,e.draggedBefore)},p=function(t){t.stopPropagation(),document.getElementById("TravelNotes-Control-TravelDataDiv").classList.toggle("TravelNotes-Control-ExpandedList");var o=document.getElementById("TravelNotes-Control-TravelDataDiv").classList.contains("TravelNotes-Control-ExpandedList");document.getElementById("TravelNotes-Control-ExpandRoutesListButton").innerHTML=o?"&#x25b3;":"&#x25bd;",document.getElementById("TravelNotes-Control-ExpandRoutesListButton").title=o?e.getText("TravelEditorUI - Reduce the list"):e.getText("TravelEditorUI - Expand the list")},T=function(e){e.stopPropagation(),at.clear(),t.travelEditor.startupRouteEdition&&at.editRoute(m.travel.routes.first.objId),m.map.fire("travelnotesfileloaded",{readOnly:!1,name:""})},f=function(e){e.stopPropagation(),at.saveTravel()},N=function(e){e.stopPropagation(),ze.cancelEdition(),Oe().openLocalFile(e)},L=function(){at.confirmClose()&&document.getElementById("TravelNotes-Control-OpenTravelInput").click()},y=function(e){e.stopPropagation(),Oe().mergeLocalFile(e)},b=function(){-1!==m.editedRouteObjId?I.showError(e.getText("TravelEditorUI - Not possible to merge a travel when a route is edited")):document.getElementById("TravelNotes-Control-ImportTravelInput").click()},C=function(e){e.stopPropagation(),at.addRoute()};return Object.seal({createUI:function(o){!function(o){if(!document.getElementById("TravelNotes-Control-TravelDataDiv")){var a=h(),I=a.create("div",{id:"TravelNotes-Control-TravelHeaderDiv",className:"TravelNotes-Control-HeaderDiv"},o);a.create("span",{innerHTML:"&#x25bc;",id:"TravelNotes-ControlTravelExpandButton",className:"TravelNotes-Control-ExpandButton"},I).addEventListener("click",i,!1),a.create("span",{innerHTML:e.getText("TravelEditorUI - Travel routes"),id:"TravelNotes-Control-TravelHeaderText",className:"TravelNotes-Control-HeaderText"},I);var E=a.create("span",{innerHTML:"&#x274c;",id:"TravelNotes-Control-PinButton"},I);E.addEventListener("click",l,!1);var D=a.create("div",{id:"TravelNotes-Control-TravelDataDiv",className:"TravelNotes-Control-DataDiv"},o);(He=H({minSize:0,id:"TravelNotes-Control-TravelRoutesList"},D)).container.addEventListener("SortableListDelete",s,!1),He.container.addEventListener("SortableListUpArrow",d,!1),He.container.addEventListener("SortableListDownArrow",u,!1),He.container.addEventListener("SortableListRightArrow",c,!1),He.container.addEventListener("SortableListChange",v,!1),He.container.addEventListener("SortableListDrop",g,!1);var x=a.create("div",{id:"TravelNotes-ControlTravelButtonsDiv",className:"TravelNotes-Control-ButtonsDiv"},o);a.create("div",{id:"TravelNotes-Control-ExpandRoutesListButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Expand the list"),innerHTML:"&#x25bd;"},x).addEventListener("click",p,!1),a.create("div",{id:"TravelNotes-Control-CancelTravelButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Cancel travel"),innerHTML:"&#x274c"},x).addEventListener("click",T,!1),a.create("div",{id:"TravelNotes-Control-SaveTravelButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Save travel"),innerHTML:"&#x1f4be;"},x).addEventListener("click",f,!1);var A=a.create("div",{id:"TravelNotes-Control-OpenTravelDiv"},x);a.create("input",{id:"TravelNotes-Control-OpenTravelInput",type:"file",accept:".trv"},A).addEventListener("change",N,!1);var R=a.create("div",{id:"TravelNotes-Control-OpenTravelFakeDiv"},A);a.create("div",{id:"TravelNotes-Control-OpenTravelButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Open travel"),innerHTML:"&#x1F4C2;"},R).addEventListener("click",L,!1);var B=a.create("div",{id:"TravelNotes-Control-ImportTravelDiv"},x);a.create("input",{id:"TravelNotes-Control-ImportTravelInput",type:"file",accept:".trv,.map"},B).addEventListener("change",y,!1);var j=a.create("div",{id:"TravelNotes-Control-ImportTravelFakeDiv"},B);a.create("div",{id:"TravelNotes-Control-ImportTravelButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Import travel"),innerHTML:"&#x1F30F;"},j).addEventListener("click",b,!1),a.create("div",{id:"TravelNotes-Control-OpenTravelRoadbookButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - Open travel roadbook"),innerHTML:'<a id="TravelNotes-Control-OpenTravelRoadbookLink" href="TravelNotesRoadbook.html?lng='+t.language+"&page="+m.UUID+'" target="_blank">&#x1F4CB;</a>'},x),a.create("div",{id:"TravelNotes-Control-AddRoutesButton",className:"TravelNotes-Control-Button",title:e.getText("TravelEditorUI - New route"),innerHTML:"+"},x).addEventListener("click",C,!1),t.travelEditor.startMinimized?(E.innerHTML="&#x1f4cc;",o.addEventListener("mouseenter",n,!1),o.addEventListener("mouseleave",r,!1),o.classList.add("TravelNotes-Control-MainDiv-Minimize")):o.classList.add("TravelNotes-Control-MainDiv-Maximize")}}(o)},setRoutesList:function(){!function(){He.removeAllItems();for(var t=m.travel.routes.iterator;!t.done;)He.addItem(t.value.name,t.value.chain?"&#x26d3;":"",e.getText("TravelEditorUI - Route"),t.value.objId,!1)}()}})},Ue=function(){return!0},Fe=function(t){var o=function(e){return{r:parseInt(e.substr(1,2),16),g:parseInt(e.substr(3,2),16),b:parseInt(e.substr(5,2),16)}},n=function(e,t,o){return String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(t||" "),this.length>e?String(this):((e-=this.length)>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))}),"#"+parseInt(e).toString(16).padStart(2,"0")+parseInt(t).toString(16).padStart(2,"0")+parseInt(o).toString(16).padStart(2,"0")},a=function(e){l=e.target.colorValue;var t=o(l);b.value=t.r,I.value=t.g,C.value=t.b,document.getElementById("TravelNotes-ColorDialog-ColorSampleDiv").setAttribute("style","background-color:"+e.target.colorValue+";")},r=function(e){for(var t=e.target.redValue,o=255,a=255,r=0;++r<7;){var i=0;for(o=255;++i<7;){var l=document.getElementById("TravelNotes-ColorDialog-CellColorDiv"+r+i);l.colorValue=n(t,o,a),l.setAttribute("style","background-color:"+n(t,o,a)),o-=51}a-=51}},i=function(){l=n(b.value,I.value,C.value),document.getElementById("TravelNotes-ColorDialog-ColorSampleDiv").setAttribute("style","background-color:"+l+";")},l=t,s=h(),d=X();d.title=e.getText("ColorDialog - Colors"),d.addClickOkButtonEventListener(Ue),d.getNewColor=function(){return l};for(var u=s.create("div",{className:"TravelNotes-ColorDialog-ColorDiv",id:"TravelNotes-ColorDialog-ColorDiv"},d.content),c=s.create("div",{className:"TravelNotes-ColorDialog-ButtonsDiv",id:"TravelNotes-ColorDialog-ButtonsDiv"},u),v=255,g=255,m=255,p=0;++p<8;){var T=s.create("div",{className:"TravelNotes-ColorDialog-RowColorDiv",id:"TravelNotes-ColorDialog-RowColorDiv"+p},c),f=0;for(g=255;++f<7;){var N=s.create("div",{className:"TravelNotes-ColorDialog-CellColorDiv",id:"TravelNotes-ColorDialog-CellColorDiv"+p+f},T);if(p<7)N.setAttribute("style","background-color:"+n(v,g,m)),N.colorValue=n(v,g,m),N.addEventListener("click",a,!1),g-=51;else{var L=n(255,v=51*(f-1),v);N.setAttribute("style","background-color:"+L),N.redValue=255-v,N.addEventListener("click",r,!1)}}m-=51}var y=s.create("div",{className:"TravelNotes-ColorDialog-DataDiv",id:"TravelNotes-ColorDialog-DataDiv"},u);s.create("text",{data:e.getText("ColorDialog - Red")},y);var b=s.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",id:"TravelNotes-ColorDialog-RedInput"},y);b.value=o(t).r,b.min=0,b.max=255,b.addEventListener("input",i,!1),s.create("text",{data:e.getText("ColorDialog - Green")},y);var I=s.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",id:"TravelNotes-ColorDialog-GreenInput"},y);I.value=o(t).g,I.min=0,I.max=255,I.addEventListener("input",i,!1),s.create("text",{data:e.getText("ColorDialog - Blue")},y);var C=s.create("input",{type:"number",className:"TravelNotes-ColorDialog-NumberInput",id:"TravelNotes-ColorDialog-BlueInput"},y);return C.value=o(t).b,C.min=0,C.max=255,C.addEventListener("input",i,!1),s.create("div",{className:"TravelNotes-ColorDialog-ColorSampleDiv",id:"TravelNotes-ColorDialog-ColorSampleDiv"},u).setAttribute("style","background-color:"+t+";"),d.center(),d},We=function(o){var n=Fe(o.color);n.title=e.getText("RoutePropertiesDialog - Route properties"),n.addClickOkButtonEventListener(function(){return o.color=n.getNewColor(),o.width=parseInt(l.value),o.chain=g.checked,o.dashArray=d.selectedIndex,tt.editRoute(o),ze.chainRoutes(),ke().setRoutesList(),at.updateRoadBook(),!0});var a=h(),r=a.create("div",{id:"TravelNotes-RoutePropertiesDialog-MainDataDiv"},n.content),i=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-WithDiv"},r);i.innerHTML="<span>"+e.getText("RoutePropertiesDialog - Width")+"</span>";var l=a.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput"},i);l.value=o.width,l.min=1,l.max=40;var s=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-dashDiv"},r);s.innerHTML="<span>"+e.getText("RoutePropertiesDialog - Linetype")+"</span>";for(var d=a.create("select",{className:"TravelNotes-RoutePropertiesDialog-Select",id:"TravelNotes-RoutePropertiesDialog-DashSelect"},s),u=t.route.dashChoices,c=0;c<u.length;c++)d.add(a.create("option",{text:u[c].text}));d.selectedIndex=o.dashArray<u.length?o.dashArray:0;var v=a.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"},r);v.innerHTML="<span>"+e.getText("RoutePropertiesDialog - Chained route")+"</span>";var g=a.create("input",{type:"checkbox",id:"TravelNotes-RoutePropertiesDialog-ChainInput"},v);return g.checked=o.chain,n};let Xe=!1;let ze=function(){let o=C(),n=U(),a=g(),r=we();function i(e,t){if(0===e.itinerary.itineraryPoints.length)return null;let o=e.itinerary.itineraryPoints.iterator;o.done;let n=Number.MAX_VALUE,a=L.Projection.SphericalMercator.project(L.latLng(t[0],t[1])),r=L.Projection.SphericalMercator.project(L.latLng(o.value.lat,o.value.lng)),i=null,l=0,s=o.value.distance;for(;!o.done;){let e=L.Projection.SphericalMercator.project(L.latLng(o.value.lat,o.value.lng)),t=L.LineUtil.pointToSegmentDistance(a,r,e);t<n&&(n=t,l=s-(i=L.Projection.SphericalMercator.unproject(L.LineUtil.closestPointOnSegment(a,r,e))).distanceTo(L.latLng(o.value.lat,o.value.lng))),s+=o.value.distance,r=e}return{latLng:[i.lat,i.lng],distance:l}}function s(){let e=m.travel.routes.iterator,t=0;for(;!e.done;){e.value.chain?(e.value.chainedDistance=t,t+=e.value.distance):e.value.chainedDistance=0;let o=e.value.notes.iterator;for(;!o.done;)o.value.chainedDistance=e.value.chainedDistance}}function d(){if(tt.removeRoute(m.travel.editedRoute,!0,!0),-1!==m.editedRouteObjId){let e=o.getRoute(m.editedRouteObjId);e.edited=0,tt.addRoute(e,!0,!1)}m.travel.editedRoute=l(),m.editedRouteObjId=-1,ke().setRoutesList(),n.setWayPointsList(),n.reduce(),r.setItinerary(),s(),at.updateRoadBook()}return Object.seal({cutRoute:(e,t)=>(function(e,t){let o=[l(),l()];o[0].object=e.object,o[1].object=e.object,o[0].itinerary.itineraryPoints.removeAll(),o[1].itinerary.itineraryPoints.removeAll();let n,a=i(e,t),r=e.itinerary.itineraryPoints.iterator,s=0,d=null,c=0;for(;!r.done;){if((n=u()).object=r.value.object,0===c&&0!=s&&s>a.distance){let e=L.latLng(a.latLng).distanceTo(L.latLng(r.value.latLng)),t=u();t.latLng=a.latLng,o[0].itinerary.itineraryPoints.add(t),o[0].distance=s-e,d&&(d.distance-=e),c=1,(t=u()).latLng=a.latLng,t.distance=e,o[1].itinerary.itineraryPoints.add(t),s=e}o[c].itinerary.itineraryPoints.add(n),s+=r.value.distance,d=n}return o[c].distance=s,o})(e,t),computeRouteDistances:e=>(function(e){let t=e.itinerary.itineraryPoints.iterator,o=e.itinerary.maneuvers.iterator;t.done,o.done;let n=t.value,a=o.value;for(a.distance=0,o.done,e.distance=0,e.duration=0;!t.done;)n.distance=L.latLng(n.latLng).distanceTo(L.latLng(t.value.latLng)),o.value.itineraryPointObjId===t.value.objId&&(e.duration+=a.duration,a=o.value,o.value.distance=0,o.done),e.distance+=n.distance,a.distance+=n.distance,n=t.value})(e),getClosestLatLngDistance:(e,t)=>i(e,t),saveGpx:()=>(function(){let e="time='"+(new Date).toISOString()+"' ",t="<?xml version='1.0'?>\n";t+="<gpx xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xsi:schemaLocation='http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd' version='1.1' creator='leaflet.TravelNotes'>";let o=m.travel.editedRoute.wayPoints.iterator;for(;!o.done;)t+="\n\t<wpt lat='"+o.value.lat+"' lon='"+o.value.lng+"' "+e+"/>";t+="\n\t<rte>";let n=m.travel.editedRoute.itinerary.maneuvers.iterator;for(;!n.done;){let o=m.travel.editedRoute.itinerary.itineraryPoints.getAt(n.value.itineraryPointObjId),a=n.value.instruction.replace("&","&amp;").replace("'","&apos;").replace('"',"&quote;").replace(">","&gt;").replace("<","&lt;");t+="\n\t\t<rtept lat='"+o.lat+"' lon='"+o.lng+"' "+e+"desc='"+a+"' />"}t+="\n\t</rte>",t+="\n\t<trk>",t+="\n\t\t<trkseg>";let r=m.travel.editedRoute.itinerary.itineraryPoints.iterator;for(;!r.done;)t+="\n\t\t\t<trkpt lat='"+r.value.lat+"' lon='"+r.value.lng+"' "+e+" />";t+="\n\t\t</trkseg>",t+="\n\t</trk>",t+="\n</gpx>";let i=m.travel.editedRoute.name;""===i&&(i="TravelNote"),i+=".gpx",a.saveFile(i,t)})(),getRouteHTML:(t,o)=>(function(t,o){let n='<div class="'+o+'Route-Header-Name">'+t.name+"</div>";return 0!==t.distance&&(n+='<div class="'+o+'Route-Header-Distance">'+e.getText("RouteEditor - Distance",{distance:a.formatDistance(t.distance)})+"</div>"),m.travel.readOnly||(n+='<div class="'+o+'Route-Header-Duration">'+e.getText("RouteEditor - Duration",{duration:a.formatTime(t.duration)})+"</div>"),n})(t,o),chainRoutes:()=>s(),startRouting:()=>void(t.routing.auto&&(Xe=0===m.travel.editedRoute.itinerary.itineraryPoints.length,W().startRouting(m.travel.editedRoute))),endRouting:()=>(function(){tt.removeRoute(m.travel.editedRoute,!0,!0);let e=m.travel.editedRoute.notes.iterator;for(;!e.done;){let t=i(m.travel.editedRoute,e.value.latLng);e.value.latLng=t.latLng,e.value.distance=t.distance}m.travel.editedRoute.notes.sort((e,t)=>e.distance-t.distance),tt.addRoute(m.travel.editedRoute,!0,!0),Xe&&tt.zoomToRoute(m.travel.editedRoute.objId),r.setItinerary(),n.setWayPointsList(),s(),at.updateRoadBook()})(),saveEdition:()=>(function(){let e=l();e.object=m.travel.editedRoute.object,m.travel.routes.replace(m.editedRouteObjId,e),m.editedRouteObjId=e.objId,d()})(),cancelEdition:()=>d(),routeProperties:e=>(function(e){let t=o.getRoute(e);We(t)})(e),hideRoute:e=>(function(e){let t=o.getRoute(e);t&&(tt.removeRoute(t,!0,!0),t.hidden=!0)})(e),showRoutes:()=>(function(){let e=m.travel.routes.iterator;for(;!e.done;)e.value.hidden&&tt.addRoute(e.value,!0,!0,!1)})()})}();let Ve=function(){let e=U(),o=K();function n(n,a){m.travel.editedRoute.edited=2;let l=r();if(n&&(l.latLng=n,t.wayPoint.reverseGeocoding&&o.getPromiseAddress(n[0],n[1],l.objId).then(i)),m.travel.editedRoute.wayPoints.add(l),tt.addWayPoint(m.travel.editedRoute.wayPoints.last,m.travel.editedRoute.wayPoints.length-2),a){let e=m.travel.editedRoute.wayPoints.iterator;for(;!e.done;)if(a<ze.getClosestLatLngDistance(m.travel.editedRoute,e.value.latLng).distance){m.travel.editedRoute.wayPoints.moveTo(l.objId,e.value.objId,!0);break}}else m.travel.editedRoute.wayPoints.swap(l.objId,!0);e.setWayPointsList(),ze.startRouting()}function a(t,o){m.travel.editedRoute.edited=2,m.travel.editedRoute.wayPoints.getAt(o).name=t,e.setWayPointsList()}function i(e){let t="";e.address.house_number&&(t+=e.address.house_number+" "),e.address.road?t+=e.address.road+" ":e.address.pedestrian&&(t+=e.address.pedestrian+" "),e.address.village?t+=e.address.village:e.address.town?t+=e.address.town:e.address.city&&(t+=e.address.city),0===t.length&&(t+=e.address.country),a(t,e.objId)}return Object.seal({addWayPoint:e=>n(e),addWayPointOnRoute:(e,t)=>(function(e,t){let o=ze.getClosestLatLngDistance(C().getRoute(e),[t.latlng.lat,t.latlng.lng]);n(o.latLng,o.distance)})(e,t),reverseWayPoints:()=>(function(){m.travel.editedRoute.edited=2;let t=m.travel.editedRoute.wayPoints.iterator;for(;!t.done;)tt.removeObject(t.value.objId);for(m.travel.editedRoute.wayPoints.reverse(),t=m.travel.editedRoute.wayPoints.iterator;!t.done;)tt.addWayPoint(t.value,t.first?"A":t.last?"B":t.index);e.setWayPointsList(),ze.startRouting()})(),removeAllWayPoints:()=>(function(){m.travel.editedRoute.edited=2;let t=m.travel.editedRoute.wayPoints.iterator;for(;!t.done;)tt.removeObject(t.value.objId);m.travel.editedRoute.wayPoints.removeAll(!0),e.setWayPointsList(),ze.startRouting()})(),removeWayPoint:t=>(t=t,m.travel.editedRoute.edited=2,tt.removeObject(t),m.travel.editedRoute.wayPoints.remove(t),e.setWayPointsList(),void ze.startRouting()),renameWayPoint:(e,t)=>a(e,t),swapWayPoints:(t,o)=>(function(t,o){m.travel.editedRoute.edited=2,m.travel.editedRoute.wayPoints.swap(t,o),e.setWayPointsList(),ze.startRouting()})(t,o),setStartPoint:n=>(n=n,m.travel.editedRoute.edited=2,0!==m.travel.editedRoute.wayPoints.first.lat&&tt.removeObject(m.travel.editedRoute.wayPoints.first.objId),m.travel.editedRoute.wayPoints.first.latLng=n,t.wayPoint.reverseGeocoding&&o.getPromiseAddress(n[0],n[1],m.travel.editedRoute.wayPoints.first.objId).then(i),tt.addWayPoint(m.travel.editedRoute.wayPoints.first,"A"),e.setWayPointsList(),void ze.startRouting()),setEndPoint:n=>(function(n){m.travel.editedRoute.edited=2,0!==m.travel.editedRoute.wayPoints.last.lat&&tt.removeObject(m.travel.editedRoute.wayPoints.last.objId),m.travel.editedRoute.wayPoints.last.latLng=n,t.wayPoint.reverseGeocoding&&o.getPromiseAddress(n[0],n[1],m.travel.editedRoute.wayPoints.last.objId).then(i),tt.addWayPoint(m.travel.editedRoute.wayPoints.last,"B"),e.setWayPointsList(),ze.startRouting()})(n),wayPointDragEnd:n=>(function(n){if(m.travel.editedRoute.edited=2,t.wayPoint.reverseGeocoding){let e=m.travel.editedRoute.wayPoints.getAt(n).latLng;o.getPromiseAddress(e[0],e[1],n).then(i)}e.setWayPointsList(),ze.startRouting()})(n),wayPointDropped:(t,o,n)=>(function(t,o,n){if(m.travel.editedRoute.edited=2,o===m.travel.editedRoute.wayPoints.first.objId&&n)return;if(o===m.travel.editedRoute.wayPoints.last.objId&&!n)return;m.travel.editedRoute.wayPoints.moveTo(t,o,n),e.setWayPointsList();let a=m.travel.editedRoute.wayPoints.iterator;for(;!a.done;)tt.removeObject(a.value.objId),tt.addWayPoint(a.value,a.first?"A":a.last?"B":a.index);ze.startRouting()})(t,o,n)});var l,s}();var Je=[],Ke=null,Ge=null,Ye=0,Ze=0,Qe=0,qe=null,_e=function(o,n){var a=function(){qe&&(clearTimeout(qe),qe=null),Ze=0,Qe=0,document.removeEventListener("keydown",r,!0),document.removeEventListener("keypress",i,!0),document.removeEventListener("keyup",l,!0);var e=Ke.childNodes;e[0].firstChild.removeEventListener("click",a,!1);for(var t=1;t<e.length;t++)e[t].firstChild.removeEventListener("click",a,!1);document.getElementsByTagName("body")[0].removeChild(Ke),Ke=null,Ye=0},r=function(e){Ke&&(e.preventDefault(),e.stopPropagation()),"Escape"!==e.key&&"Esc"!==e.key||a(),"ArrowDown"!==e.key&&"ArrowRight"!==e.key&&"Tab"!==e.key||(Ye=Ye>=Je.length?1:++Ye,Ke.childNodes[Ye].firstChild.focus()),"ArrowUp"!==e.key&&"ArrowLeft"!==e.key||(Ye=Ye<=1?Je.length:--Ye,Ke.childNodes[Ye].firstChild.focus()),"Home"===e.key&&(Ye=1,Ke.childNodes[Ye].firstChild.focus()),"End"===e.key&&(Ye=Je.length,Ke.childNodes[Ye].firstChild.focus()),"Enter"===e.key&&Ye>0&&Je[Ye-1].action&&Ke.childNodes[Ye].firstChild.click()},i=function(e){e.preventDefault(),e.stopPropagation()},l=function(e){e.preventDefault(),e.stopPropagation()},s=function(e){e.stopPropagation(),Je[e.target.menuItem].param?Je[e.target.menuItem].action.call(Je[e.target.menuItem].context,Je[e.target.menuItem].param,Ge):Je[e.target.menuItem].action.call(Je[e.target.menuItem].context,Ge),a()};if(o.latlng.lat===Ze&&o.latlng.lng===Qe)return Ze=0,void(Qe=0);if(Ze=o.latlng.lat,Qe=o.latlng.lng,Ge=o,Ke)a();else{Je=n;var d=document.getElementsByTagName("body")[0],u=h(),c=u.create("div",{className:"TravelNotes-ContextMenu-Panel"},d),v=c.clientWidth,g=c.clientHeight;d.removeChild(c),(Ke=u.create("div",{id:"TravelNotes-ContextMenu-Container",className:"TravelNotes-ContextMenu-Container"},d)).addEventListener("mouseenter",function(){qe&&(clearTimeout(qe),qe=null)},!1),Ke.addEventListener("mouseleave",function(){qe=setTimeout(a,t.contextMenu.timeout)},!1),u.create("div",{innerHTML:"&#x274c",className:"TravelNotes-ContextMenu-CloseButton",title:e.getText("ContextMenu - Close")},Ke).addEventListener("click",a,!1);var m=0;Je.forEach(function(e){var t=u.create("div",{className:"TravelNotes-ContextMenu-ItemContainer"},Ke),o=u.create("button",{innerHTML:e.name,id:"TravelNotes-ContextMenu-Item"+m,className:e.action?"TravelNotes-ContextMenu-Item":"TravelNotes-ContextMenu-Item TravelNotes-ContextMenu-ItemDisabled"},t);e.action&&o.addEventListener("click",s,!1),o.menuItem=m,++m});var p=Math.min(o.originalEvent.clientY,g-Ke.clientHeight-20),T=Math.min(o.originalEvent.clientX,v-Ke.clientWidth-20);Ke.setAttribute("style","top:"+p+"px;left:"+T+"px;"),document.addEventListener("keydown",r,!0),document.addEventListener("keypress",i,!0),document.addEventListener("keyup",l,!0)}},$e=function(){var t=X();return t.title=e.getText("AboutDialog - About Travel & Notes"),h().create("div",{id:"TravelNotes-AboutDialog-AboutDiv"},t.content).innerHTML="<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2019 - wwwouaiebe</p><p>Contact : <a href='http://www.ouaie.be/blog/pages/contact' target='_blank'>http://www.ouaie.be/</a></p><p>GitHub : <a href='https://github.com/wwwouaiebe/leaflet.TravelNotes' target='_blank'>https://github.com/wwwouaiebe/leaflet.TravelNotes</a></p><p>Version : 1.6.0.<p>This program uses: <a href='https://leafletjs.com/' target='_blank'>leaflet</a>, <a href='https://github.com/mapbox/polyline' target='_blank'>mapbox/polyline</a>, <a href='https://github.com/Project-OSRM/osrm-text-instructions' target='_blank'>Project-OSRM/osrm-text-instructions</a> and  <a href='https://github.com/drolbr/Overpass-API' target='_blank'>the Overpass API</a></p>",t.center(),t},et=function(){return Object.seal({getMapContextMenu:function(t){return function(t){return[{context:Ve,name:e.getText("ContextMenuFactory - Select this point as start point"),action:-1!==m.editedRouteObjId&&0===m.travel.editedRoute.wayPoints.first.lat?Ve.setStartPoint:null,param:t},{context:Ve,name:e.getText("ContextMenuFactory - Select this point as way point"),action:-1!==m.editedRouteObjId?Ve.addWayPoint:null,param:t},{context:Ve,name:e.getText("ContextMenuFactory - Select this point as end point"),action:-1!==m.editedRouteObjId&&0===m.travel.editedRoute.wayPoints.last.lat?Ve.setEndPoint:null,param:t},{context:q,name:e.getText("ContextMenuFactory - New travel note"),action:q.newTravelNote,param:t},{context:q,name:e.getText("ContextMenuFactory - Hide notes"),action:q.hideNotes},{context:q,name:e.getText("ContextMenuFactory - Show notes"),action:q.showNotes},{context:ze,name:e.getText("ContextMenuFactory - Show all routes"),action:ze.showRoutes},{context:tt,name:e.getText("ContextMenuFactory - Zoom to travel"),action:tt.zoomToTravel},{context:null,name:e.getText("ContextMenuFactory - About Travel & Notes"),action:$e}]}(t)},getWayPointContextMenu:function(t){return function(t){return[{context:Ve,name:e.getText("ContextMenuFactory - Delete this waypoint"),action:m.travel.editedRoute.wayPoints.first.objId!==t&&m.travel.editedRoute.wayPoints.last.objId!==t?Ve.removeWayPoint:null,param:t}]}(t)},getRouteContextMenu:function(t){return function(t){return[{context:ze,name:e.getText("ContextMenuFactory - Edit this route"),action:m.editedRouteObjId!==t&&2!==m.travel.editedRoute.edited?at.editRoute:null,param:t},{context:at,name:e.getText("ContextMenuFactory - Delete this route"),action:m.editedRouteObjId!==t&&2!==m.travel.editedRoute.edited?at.removeRoute:null,param:t},{context:ze,name:e.getText("ContextMenuFactory - Hide this route"),action:m.travel.editedRoute.objId!==t?ze.hideRoute:null,param:t},{context:Ve,name:e.getText("ContextMenuFactory - Add a waypoint on the route"),action:-1!==m.editedRouteObjId?Ve.addWayPointOnRoute:null,param:t},{context:q,name:e.getText("ContextMenuFactory - Add a note on the route"),action:q.newRouteNote,param:t},{context:ze,name:e.getText("ContextMenuFactory - Properties"),action:ze.routeProperties,param:t},{context:tt,name:e.getText("ContextMenuFactory - Zoom to route"),action:tt.zoomToRoute,param:t},{context:ze,name:e.getText("ContextMenuFactory - Save modifications on this route"),action:m.travel.editedRoute.objId===t?ze.saveEdition:null},{context:ze,name:e.getText("ContextMenuFactory - Cancel modifications on this route"),action:m.travel.editedRoute.objId===t?ze.cancelEdition:null}]}(t)},getNoteContextMenu:function(t){return function(t){var o=[];o.push({context:q,name:e.getText("ContextMenuFactory - Edit this note"),action:q.editNote,param:t}),o.push({context:q,name:e.getText("ContextMenuFactory - Delete this note"),action:q.removeNote,param:t}),o.push({context:q,name:e.getText("ContextMenuFactory - Zoom to note"),action:q.zoomToNote,param:t});var n=C().getNoteAndRoute(t).route;return o.push({context:q,name:n?e.getText("ContextMenuFactory - Detach note from route"):e.getText("ContextMenuFactory - Attach note to route"),action:0!==m.travel.routes.length&&-1===m.editedRouteObjId?n?q.detachNoteFromRoute:q.attachNoteToRoute:null,param:t}),o}(t)}})};let tt=function(){let e=C(),o=et();function n(t){let o=e.getRoute(t.target.objId),n=ze.getClosestLatLngDistance(o,[t.latlng.lat,t.latlng.lng]).distance;n+=o.chainedDistance,n=g().formatDistance(n);let a=m.mapObjects.get(t.target.objId);a.closeTooltip();let r=e.getRoute(t.target.objId).name;m.travel.readOnly||(r+=0===r.length?"":" - ",r+=n),a.setTooltipContent(r),a.openTooltip(t.latlng)}function a(e,t){t.objId=e,t.addTo(m.map),m.mapObjects.set(e,t)}function r(e){let t=m.mapObjects.get(e);t&&(L.DomEvent.off(t),m.map.removeLayer(t),m.mapObjects.delete(e))}function i(e){let t=L.latLng([90,180]),o=L.latLng([-90,-180]);return e.forEach(e=>{t.lat=Math.min(t.lat,e[0]),t.lng=Math.min(t.lng,e[1]),o.lat=Math.max(o.lat,e[0]),o.lng=Math.max(o.lng,e[1])}),L.latLngBounds(t,o)}function l(e){let t=[];return e.itinerary.itineraryPoints.forEach(e=>t.push(e.latLng)),e.notes.forEach(e=>{t.push(e.latLng),t.push(e.iconLatLng)}),t}function s(e){e.dashArray>=t.route.dashChoices.length&&(e.dashArray=0);let o=t.route.dashChoices[e.dashArray].iDashArray;if(o){let t="",n=0;for(n=0;n<o.length-1;n++)t+=o[n]*e.width+",";return t+=o[n]*e.width}return null}function d(e){m.map.setView(e,t.itineraryPointZoom)}function u(t,n){if(0===t.lat&&0===t.lng)return;let r='<div class="TravelNotes-WayPoint TravelNotes-WayPoint'+("A"===n?"Start":"B"===n?"End":"Via")+'"></div><div class="TravelNotes-WayPointText">'+n+"</div>",i=L.marker(t.latLng,{icon:L.divIcon({iconSize:[40,40],iconAnchor:[20,40],html:r,className:"TravelNotes-WayPointStyle"}),draggable:!0});i.bindTooltip(function(t){return e.getWayPoint(t.objId).UIName}),i.getTooltip().options.offset=[20,-20],L.DomEvent.on(i,"contextmenu",function(e){_e(e,o.getWayPointContextMenu(e.target.objId))}),i.objId=t.objId,a(t.objId,i),L.DomEvent.on(i,"dragend",e=>{m.travel.editedRoute.wayPoints.getAt(e.target.objId).latLng=[e.target.getLatLng().lat,e.target.getLatLng().lng],Ve.wayPointDragEnd(e.target.objId)})}function c(n,r){r=r||!1;let i=L.marker(n.latLng,{icon:L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>"}),zIndexOffset:-1e3,opacity:t.note.grip.opacity,draggable:!r});i.objId=n.objId,r||(L.DomEvent.on(i,"dragend",t=>{let o=e.getNoteAndRoute(t.target.objId),n=o.note,a=o.route,r=m.mapObjects.get(t.target.objId),i=we();if(null!=a){let e=ze.getClosestLatLngDistance(a,[t.target.getLatLng().lat,t.target.getLatLng().lng]);n.latLng=e.latLng,n.distance=e.distance,a.notes.sort((e,t)=>e.distance-t.distance),r.getLayer(r.bulletId).setLatLng(e.latLng),i.updateItinerary()}else n.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],i.updateTravelNotes();r.getLayer(r.polylineId).setLatLngs([n.latLng,n.iconLatLng]),at.updateRoadBook()}),L.DomEvent.on(i,"drag",t=>{let o=e.getNoteAndRoute(t.target.objId).note,n=m.mapObjects.get(t.target.objId);n.getLayer(n.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],o.iconLatLng])}));let l=L.divIcon({iconSize:[n.iconWidth,n.iconHeight],iconAnchor:[n.iconWidth/2,n.iconHeight/2],popupAnchor:[0,-n.iconHeight/2],html:n.iconContent,className:t.note.style}),s=L.marker(n.iconLatLng,{icon:l,draggable:!r});s.objId=n.objId,s.bindPopup(t=>{let o=e.getNoteAndRoute(t.objId).note;return q.getNoteHTML(o,"TravelNotes-")}),0!==n.tooltipContent.length&&(s.bindTooltip(t=>e.getNoteAndRoute(t.objId).note.tooltipContent),s.getTooltip().options.offset[0]=n.iconWidth/2),r||(L.DomEvent.on(s,"contextmenu",e=>_e(e,o.getNoteContextMenu(e.target.objId))),L.DomEvent.on(s,"dragend",t=>{let o=e.getNoteAndRoute(t.target.objId).note;o.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];let n=m.mapObjects.get(t.target.objId);n.getLayer(n.polylineId).setLatLngs([o.latLng,o.iconLatLng])}),L.DomEvent.on(s,"drag",t=>{let o=e.getNoteAndRoute(t.target.objId).note,n=m.mapObjects.get(t.target.objId);n.getLayer(n.polylineId).setLatLngs([o.latLng,[t.latlng.lat,t.latlng.lng]])}));let d=L.polyline([n.latLng,n.iconLatLng],t.note.polyline);d.objId=n.objId;let u=L.layerGroup([s,d,i]);u.markerId=L.Util.stamp(s),u.polylineId=L.Util.stamp(d),u.bulletId=L.Util.stamp(i),a(n.objId,u)}return Object.seal({removeRoute:(e,t,o)=>(function(e,t,o){if(r(e.objId),t){let t=e.notes.iterator;for(;!t.done;)r(t.value.objId)}if(o){let t=e.wayPoints.iterator;for(;!t.done;)r(t.value.objId)}})(e,t,o),addRoute:(t,r,i,l)=>(function(t,r,i,l){l=l||!1;let d=[],v=t.itinerary.itineraryPoints.iterator;for(;!v.done;)d.push(v.value.latLng);let g=L.polyline(d,{color:t.color,weight:t.width,dashArray:s(t)});if(a(t.objId,g),g.bindTooltip(t.name,{sticky:!0,direction:"right"}),g.on("mouseover",n),g.on("mousemove",n),g.bindPopup(t=>{let o=e.getRoute(t.objId);return ze.getRouteHTML(o,"TravelNotes-")}),L.DomEvent.on(g,"click",e=>e.target.openPopup(e.latlng)),l||L.DomEvent.on(g,"contextmenu",e=>_e(e,o.getRouteContextMenu(e.target.objId))),r){let e=t.notes.iterator;for(;!e.done;)c(e.value,l)}if(i){let e=m.travel.editedRoute.wayPoints.iterator;for(;!e.done;)u(e.value,e.first?"A":e.last?"B":e.index)}})(t,r,i,l),editRoute:e=>(e=e,void m.mapObjects.get(e.objId).setStyle({color:e.color,weight:e.width,dashArray:s(e)})),removeObject:e=>r(e),removeAllObjects:()=>(m.mapObjects.forEach(e=>{L.DomEvent.off(e),m.map.removeLayer(e)}),void m.mapObjects.clear()),zoomToPoint:e=>d(e),zoomToSearchResult:(e,t)=>(function(e,t){if(t){let e=[];t.forEach(t=>e=e.concat(t)),m.map.fitBounds(i(e))}else d(e)})(e,t),zoomToNote:t=>(t=t,void d(e.getNoteAndRoute(t).note.iconLatLng)),zoomToRoute:t=>(function(t){let o=l(e.getRoute(t));0!==o.length&&m.map.fitBounds(i(o))})(t),zoomToTravel:()=>(function(){let e=[];m.travel.routes.forEach(t=>{e=e.concat(l(t))}),e=e.concat(l(m.travel.editedRoute)),m.travel.notes.forEach(t=>{e.push(t.latLng),e.push(t.iconLatLng)}),0!==e.length&&m.map.fitBounds(i(e))})(),addItineraryPointMarker:(e,o)=>(e=e,o=o,void a(e,L.circleMarker(o,t.itineraryPointMarker))),addSearchPointMarker:(e,o,n)=>(function(e,o,n){let r=!1;if(n){let e=[];n.forEach(t=>{e=e.concat(t)});let t=i(e),o=m.map.getBounds();r=(t.getEast()-t.getWest())/(o.getEast()-o.getWest())>.01&&(t.getNorth()-t.getSouth())/(o.getNorth()-o.getSouth())>.01}a(e,r?L.polyline(n,t.searchPointPolyline):L.circleMarker(o,t.searchPointMarker))})(e,o,n),addRectangle:(e,t,o)=>(function(e,t,o){a(e,L.rectangle(t,o))})(e,t,o),addWayPoint:(e,t)=>u(e,t),redrawNote:e=>(e=e,r(e.objId),void c(e)),addNote:(e,t)=>c(e,t),editNote:o=>(function(o){let n=L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:t.note.style}),a=m.mapObjects.get(o.objId),r=a.getLayer(a.markerId);r.setIcon(n),r.unbindTooltip(),0!==o.tooltipContent.length&&(r.bindTooltip(t=>e.getNoteAndRoute(t.objId).note.tooltipContent),r.getTooltip().options.offset[0]=o.iconWidth/2),r.isPopupOpen()&&(r.closePopup(),r.openPopup())})(o)});var v,p,T,f,N}(),ot=!1,nt=!1;let at=function(){let o=ke(),n=U(),a=g(),r=C(),i=we();function s(e){if(nt||(window.addEventListener("unload",()=>localStorage.removeItem(m.UUID+"-TravelNotesHTML")),nt=!0),e||ot||!t.haveBeforeUnloadWarning||(window.addEventListener("beforeunload",e=>(e.returnValue="x","x")),ot=!0),a.storageAvailable("localStorage")){let e=_();e.classNamePrefix="TravelNotes-Roadbook-",localStorage.setItem(m.UUID+"-TravelNotesHTML",e.travelHTML.outerHTML)}}function d(t){if(2===m.travel.editedRoute.edited)return void I.showError(e.getText("RouteEditor - Not possible to edit a route without a save or cancel"));-1!==m.editedRouteObjId&&ze.cancelEdition();let o=r.getRoute(t),a=o.itinerary.provider;if(a&&""!==a&&!m.providers.get(a.toLowerCase()))return void I.showError(e.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:a}));let s=Se();a&&""!==a&&(s.provider=a);let d=o.itinerary.transitMode;d&&""!==d&&(s.transitMode=d),m.travel.editedRoute=l(),o.edited=1,m.travel.editedRoute.object=o.object,m.editedRouteObjId=o.objId,m.travel.editedRoute.hidden=!1,o.hidden=!1,tt.removeRoute(o,!0,!1),tt.addRoute(m.travel.editedRoute,!0,!0),ze.chainRoutes(),n.expand(),n.setWayPointsList(),i.setItinerary()}function u(e){let t={};0!==e.itinerary.itineraryPoints.length&&(t=e.itinerary.itineraryPoints[0].objType);let o={latLngs:[],distances:[],objIds:[],objType:t};e.itinerary.itineraryPoints.forEach(e=>{o.latLngs.push([e.lat,e.lng]),o.distances.push(e.distance),o.objIds.push(e.objId)}),o.latLngs=p.encode(o.latLngs,6),e.itinerary.itineraryPoints=o}function c(){return!ot||window.confirm(e.getText("TravelEditor - This page ask to close; data are perhaps not saved."))}return Object.seal({updateRoadBook:e=>s(e),addRoute:()=>(function(){let e=l();m.travel.routes.add(e),o.setRoutesList(),ze.chainRoutes(),s(),2!==m.travel.editedRoute.edited&&d(e.objId)})(),removeRoute:t=>(t=t,void(t!==m.editedRouteObjId||2!==m.travel.editedRoute.edited?(tt.removeRoute(r.getRoute(t),!0,!0),m.travel.routes.remove(t),o.setRoutesList(),t===m.editedRouteObjId&&ze.cancelEdition(),ze.chainRoutes(),s()):I.showError(e.getText("TravelEditor - Cannot remove an edited route")))),editRoute:e=>d(e),renameRoute:(e,t)=>(function(e,t){r.getRoute(e).name=t,o.setRoutesList(),e===m.editedRouteObjId&&(m.travel.editedRoute.name=t),s()})(e,t),swapRoute:(e,t)=>(function(e,t){m.travel.routes.swap(e,t),o.setRoutesList(),ze.chainRoutes(),s()})(e,t),routeDropped:(e,t,n)=>(e=e,t=t,n=n,m.travel.routes.moveTo(e,t,n),o.setRoutesList(),ze.chainRoutes(),void s()),saveTravel:()=>(function(){let e=m.travel.routes.iterator;for(;!e.done;)e.value.hidden=!1;let t=m.travel.object;t.routes.forEach(u),u(t.editedRoute),a.saveFile(t.name+".trv",JSON.stringify(t))})(),confirmClose:()=>c(),clear:()=>void(c()&&(tt.removeAllObjects(),m.travel.editedRoute=l(),m.editedRouteObjId=-1,m.travel=v(),m.travel.routes.add(l()),o.setRoutesList(),n.setWayPointsList(),i.setItinerary(),s(!0)))});var T,f,N,h}();var rt,it,lt,st,dt,ut,ct,vt,gt,mt,pt;L.travelNotes=(rt=[],it=[],lt=!1,st=!1,dt=null,ut=null,ct="",vt=function(e,t){var o=new XMLHttpRequest;o.timeout=2e4,o.ontimeout=function(){t("XMLHttpRequest TimeOut. File : "+o.responseURL)},o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var n;try{n=JSON.parse(o.responseText)}catch(e){t("JSON parsing error. File : "+o.responseURL)}e(n)}else t("Error XMLHttpRequest - Status : "+o.status+" - StatusText : "+o.statusText+" - File : "+o.responseURL)},o.open("GET",ct,!0),o.overrideMimeType("application/json"),o.send(null)},gt=function(o,n){var a;m.map=o,a="?",decodeURI(window.location.search).substr(1).split("&").forEach(function(e){if("fil="===e.substr(0,4).toLowerCase())ut=decodeURIComponent(escape(atob(e.substr(4)))),a+="?"===a?"":"&",a+=e;else{var t=e.split("=");if(2===t.length)if(-1!==t[0].indexOf("ProviderKey")){var o=t[0].substr(0,t[0].length-11).toLowerCase(),n=m.providers.get(o);n&&n.providerKeyNeeded&&(n.providerKey=t[1]),sessionStorage.setItem(o,btoa(t[1]))}else a+="?"===a?"":"&",a+=e,"lng"===t[0].toLowerCase()&&(dt=t[1].toLowerCase())}}),history.replaceState({index:"bar"},"page",a),m.providers.forEach(function(e){if(e.providerKeyNeeded&&0===e.providerKey){var t=null;g().storageAvailable("sessionStorage")&&(t=sessionStorage.getItem(e.name.toLowerCase())),t?e.providerKey=atob(t):m.providers.delete(e.name.toLowerCase())}});var r=[];ct=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotesConfig.json",r.push(new Promise(vt)),ct=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes"+(dt||t.language).toUpperCase()+".json",r.push(new Promise(vt)),ut&&(ct=ut,r.push(new Promise(vt))),Promise.all(r).then(function(o){var a,r;dt&&(o[0].language=dt),t.overload(o[0]),window.osmSearch?window.osmSearch.getDictionaryPromise(t.language,"travelNotes").then(function(){console.log("Dictionary loaded")},function(e){console.log(e)}):console.log("osmSearch not found"),m.providers.forEach(function(e){e.userLanguage=t.language}),e.setTranslations(o[1]),m.travel=v(),m.travel.routes.add(l()),document.getElementById(n).appendChild((r=document.getElementById("TravelNotes-Control-MainDiv"),r||(a=h(),r=a.create("div",{id:"TravelNotes-Control-MainDiv"}),a.create("div",{id:"TravelNotes-Control-MainDiv-Title",innerHTML:"Travel&nbsp;&amp;&nbsp;Notes"},r),ke().createUI(r),U().createUI(r),we().createUI(r),Se().createUI(r),b().createUI(r),r.addEventListener("click",function(e){e.target.classList.contains("TravelNotes-SortableList-ItemInput")||e.target.id&&-1!==["TravelNotes-Control-OpenTravelInput","TravelNotes-Control-OpenTravelButton","TravelNotes-Control-ImportTravelInput","TravelNotes-Control-ImportTravelButton","TravelNotes-Control-OpenTravelRoadbookLink"].indexOf(e.target.id)||(e.stopPropagation(),e.preventDefault())},!1),r.addEventListener("dblclick",function(e){e.stopPropagation(),e.preventDefault()},!1),r.addEventListener("wheel",function(e){e.stopPropagation(),e.preventDefault()},!1)),{get UI(){return r}}).UI),ke().setRoutesList(m.travel.routes),at.updateRoadBook(!0),ut?Oe().openDistantFile(o[2]):t.travelEditor.startupRouteEdition?at.editRoute(m.travel.routes.first.objId):U().reduce()}).catch(function(e){console.log(e)})},mt=function(e){m.travel.readOnly||_e(e,et().getMapContextMenu([e.latlng.lat,e.latlng.lng]).concat(rt))},pt=function(e){m.travel.readOnly||_e(e,et().getMapContextMenu([e.latlng.lat,e.latlng.lng]).concat(it))},{addControl:function(e,t){return gt(e,t)},addProvider:function(e){m.providers.set(e.name.toLowerCase(),e)},addMapContextMenu:function(e,t){e&&(m.map.on("click",mt),lt=!0),t&&(m.map.on("contextmenu",mt),st=!0)},get baseDialog(){return X()},get userData(){return m.travel.userData},set userData(e){m.travel.userData=e},get rightContextMenu(){return st},set rightContextMenu(e){e&&!st?(m.map.on("contextmenu",pt),st=!0):!e&&st&&(m.map.off("contextmenu",pt),st=!1)},get leftContextMenu(){return lt},set leftContextMenu(e){e&&!lt?(m.map.on("click",mt),lt=!0):!e&&lt&&(m.map.off("click",mt),lt=!1)},get leftUserContextMenu(){return rt},set leftUserContextMenu(e){rt=e},get rightUserContextMenu(){return it},set rightUserContextMenu(e){it=e},get maneuver(){return d()},get itineraryPoint(){return u()},get version(){return"1.6.0"}})}();